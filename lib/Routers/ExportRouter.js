"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ExportRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _AdapterLoader = require("../Adapters/AdapterLoader");

var _rest = _interopRequireDefault(require("../rest"));

var _archiver = _interopRequireDefault(require("archiver"));

var _tmp = _interopRequireDefault(require("tmp"));

var _fs = _interopRequireDefault(require("fs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DefaultExportExportProgressCollectionName = '_ExportProgress';
const relationSchema = {
  fields: {
    relatedId: {
      type: 'String'
    },
    owningId: {
      type: 'String'
    }
  }
};

class ExportRouter extends _PromiseRouter.default {
  exportClassPage(req, className, jsonFileStream, where, skip, limit) {
    const databaseController = req.config.database;
    const options = {
      skip,
      limit
    };
    const findPromise = className.indexOf('_Join') === 0 ? databaseController.adapter.find(className, relationSchema, where, options) : _rest.default.find(req.config, req.auth, className, where, options);
    return findPromise.then(data => {
      if (Array.isArray(data)) {
        data = {
          results: data.map(obj => {
            // Needed to avoid errors during import.
            // See more: https://docs.parseplatform.org/js/guide/#error-codes
            // Deletes invalid keys in order to avoid "ParseError: 105 Invalid field name"
            // when importing
            Object.keys(obj).forEach(key => {
              if (key.startsWith('_')) {
                delete obj[key];
              }
            });
            return obj;
          })
        };
      }

      if (skip && data.results.length) {
        jsonFileStream.write(',\n');
      }

      jsonFileStream.write(JSON.stringify(data.results, null, 2).substr(1).slice(0, -1));
    });
  }

  exportClass(req, data) {
    const databaseController = req.config.database;

    const tmpJsonFile = _tmp.default.fileSync();

    const jsonFileStream = _fs.default.createWriteStream(tmpJsonFile.name);

    jsonFileStream.write('{\n"results" : [\n');
    const hasJoin = data.name.indexOf('_Join') === 0;
    let findPromise = null;

    if (hasJoin) {
      findPromise = databaseController.adapter.count(data.name, relationSchema, data.where);
    } else {
      findPromise = _rest.default.find(req.config, req.auth, data.name, data.where, {
        count: true,
        limit: 0
      });
    }

    return findPromise.then(result => {
      if (Number.isInteger(result)) {
        result = {
          count: result
        };
      }

      let i = 0;
      const pageLimit = 1000;
      let promise = Promise.resolve();

      for (i = 0; i < result.count; i += pageLimit) {
        const skip = i;
        promise = promise.then(() => {
          return this.exportClassPage(req, data.name, jsonFileStream, data.where, skip, pageLimit);
        });
      }

      return promise;
    }).then(() => {
      jsonFileStream.end(']\n}');
      return new Promise(resolve => {
        jsonFileStream.on('close', () => {
          tmpJsonFile._name = `${data.name.replace(/:/g, 'êž‰')}.json`;
          resolve(tmpJsonFile);
        });
      });
    });
  }

  handleExportProgress(req) {
    const databaseController = req.config.database;
    const query = {
      masterKey: req.info.masterKey,
      applicationId: req.info.appId
    };
    return databaseController.find(DefaultExportExportProgressCollectionName, query).then(response => {
      return {
        response
      };
    });
  }

  handleExport(req) {
    const databaseController = req.config.database;
    const emailControllerAdapter = (0, _AdapterLoader.loadAdapter)(req.config.emailAdapter);

    if (!emailControllerAdapter) {
      return Promise.reject(new Error('You have to setup a Mail Adapter.'));
    }

    const exportProgress = {
      id: req.body.name,
      masterKey: req.info.masterKey,
      applicationId: req.info.appId
    };
    databaseController.create(DefaultExportExportProgressCollectionName, exportProgress).then(() => {
      return databaseController.loadSchema({
        clearCache: true
      });
    }).then(schemaController => schemaController.getOneSchema(req.body.name, true)).then(schema => {
      const classNames = [req.body.name];
      Object.keys(schema.fields).forEach(fieldName => {
        const field = schema.fields[fieldName];

        if (field.type === 'Relation') {
          classNames.push(`_Join:${fieldName}:${req.body.name}`);
        }
      });
      const promisses = classNames.map(name => {
        return this.exportClass(req, {
          name
        });
      });
      return Promise.all(promisses);
    }).then(jsonFiles => {
      return new Promise(resolve => {
        const tmpZipFile = _tmp.default.fileSync();

        const tmpZipStream = _fs.default.createWriteStream(tmpZipFile.name);

        const zip = (0, _archiver.default)('zip');
        zip.pipe(tmpZipStream);
        jsonFiles.forEach(tmpJsonFile => {
          zip.append(_fs.default.readFileSync(tmpJsonFile.name), {
            name: tmpJsonFile._name
          });
          tmpJsonFile.removeCallback();
        });
        zip.finalize();
        tmpZipStream.on('close', () => {
          const buf = _fs.default.readFileSync(tmpZipFile.name);

          tmpZipFile.removeCallback();
          resolve(buf);
        });
      });
    }).then(zippedFile => {
      const filesController = req.config.filesController;
      return filesController.createFile(req.config, req.body.name, zippedFile, 'application/zip');
    }).then(fileData => {
      return emailControllerAdapter.sendMail({
        text: `We have successfully exported your data from the class ${req.body.name}.\n
        Please download from ${fileData.url}`,
        link: fileData.url,
        to: req.body.feedbackEmail,
        subject: 'Export completed'
      });
    }).catch(error => {
      return emailControllerAdapter.sendMail({
        text: `We could not export your data to the class ${req.body.name}. Error: ${error}`,
        to: req.body.feedbackEmail,
        subject: 'Export failed'
      });
    }).then(() => {
      return databaseController.destroy(DefaultExportExportProgressCollectionName, exportProgress);
    });
    return Promise.resolve({
      response: 'We are exporting your data. You will be notified by e-mail once it is completed.'
    });
  }

  mountRoutes() {
    this.route('PUT', '/export_data', req => {
      return this.handleExport(req);
    });
    this.route('GET', '/export_progress', req => {
      return this.handleExportProgress(req);
    });
  }

}

exports.ExportRouter = ExportRouter;
var _default = ExportRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0V4cG9ydFJvdXRlci5qcyJdLCJuYW1lcyI6WyJEZWZhdWx0RXhwb3J0RXhwb3J0UHJvZ3Jlc3NDb2xsZWN0aW9uTmFtZSIsInJlbGF0aW9uU2NoZW1hIiwiZmllbGRzIiwicmVsYXRlZElkIiwidHlwZSIsIm93bmluZ0lkIiwiRXhwb3J0Um91dGVyIiwiUHJvbWlzZVJvdXRlciIsImV4cG9ydENsYXNzUGFnZSIsInJlcSIsImNsYXNzTmFtZSIsImpzb25GaWxlU3RyZWFtIiwid2hlcmUiLCJza2lwIiwibGltaXQiLCJkYXRhYmFzZUNvbnRyb2xsZXIiLCJjb25maWciLCJkYXRhYmFzZSIsIm9wdGlvbnMiLCJmaW5kUHJvbWlzZSIsImluZGV4T2YiLCJhZGFwdGVyIiwiZmluZCIsInJlc3QiLCJhdXRoIiwidGhlbiIsImRhdGEiLCJBcnJheSIsImlzQXJyYXkiLCJyZXN1bHRzIiwibWFwIiwib2JqIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJzdGFydHNXaXRoIiwibGVuZ3RoIiwid3JpdGUiLCJKU09OIiwic3RyaW5naWZ5Iiwic3Vic3RyIiwic2xpY2UiLCJleHBvcnRDbGFzcyIsInRtcEpzb25GaWxlIiwidG1wIiwiZmlsZVN5bmMiLCJmcyIsImNyZWF0ZVdyaXRlU3RyZWFtIiwibmFtZSIsImhhc0pvaW4iLCJjb3VudCIsInJlc3VsdCIsIk51bWJlciIsImlzSW50ZWdlciIsImkiLCJwYWdlTGltaXQiLCJwcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJlbmQiLCJvbiIsIl9uYW1lIiwicmVwbGFjZSIsImhhbmRsZUV4cG9ydFByb2dyZXNzIiwicXVlcnkiLCJtYXN0ZXJLZXkiLCJpbmZvIiwiYXBwbGljYXRpb25JZCIsImFwcElkIiwicmVzcG9uc2UiLCJoYW5kbGVFeHBvcnQiLCJlbWFpbENvbnRyb2xsZXJBZGFwdGVyIiwiZW1haWxBZGFwdGVyIiwicmVqZWN0IiwiRXJyb3IiLCJleHBvcnRQcm9ncmVzcyIsImlkIiwiYm9keSIsImNyZWF0ZSIsImxvYWRTY2hlbWEiLCJjbGVhckNhY2hlIiwic2NoZW1hQ29udHJvbGxlciIsImdldE9uZVNjaGVtYSIsInNjaGVtYSIsImNsYXNzTmFtZXMiLCJmaWVsZE5hbWUiLCJmaWVsZCIsInB1c2giLCJwcm9taXNzZXMiLCJhbGwiLCJqc29uRmlsZXMiLCJ0bXBaaXBGaWxlIiwidG1wWmlwU3RyZWFtIiwiemlwIiwicGlwZSIsImFwcGVuZCIsInJlYWRGaWxlU3luYyIsInJlbW92ZUNhbGxiYWNrIiwiZmluYWxpemUiLCJidWYiLCJ6aXBwZWRGaWxlIiwiZmlsZXNDb250cm9sbGVyIiwiY3JlYXRlRmlsZSIsImZpbGVEYXRhIiwic2VuZE1haWwiLCJ0ZXh0IiwidXJsIiwibGluayIsInRvIiwiZmVlZGJhY2tFbWFpbCIsInN1YmplY3QiLCJjYXRjaCIsImVycm9yIiwiZGVzdHJveSIsIm1vdW50Um91dGVzIiwicm91dGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLHlDQUF5QyxHQUFHLGlCQUFsRDtBQUNBLE1BQU1DLGNBQWMsR0FBRztBQUNyQkMsRUFBQUEsTUFBTSxFQUFFO0FBQUVDLElBQUFBLFNBQVMsRUFBRTtBQUFFQyxNQUFBQSxJQUFJLEVBQUU7QUFBUixLQUFiO0FBQWlDQyxJQUFBQSxRQUFRLEVBQUU7QUFBRUQsTUFBQUEsSUFBSSxFQUFFO0FBQVI7QUFBM0M7QUFEYSxDQUF2Qjs7QUFJTyxNQUFNRSxZQUFOLFNBQTJCQyxzQkFBM0IsQ0FBeUM7QUFDOUNDLEVBQUFBLGVBQWUsQ0FBQ0MsR0FBRCxFQUFNQyxTQUFOLEVBQWlCQyxjQUFqQixFQUFpQ0MsS0FBakMsRUFBd0NDLElBQXhDLEVBQThDQyxLQUE5QyxFQUFxRDtBQUNsRSxVQUFNQyxrQkFBa0IsR0FBR04sR0FBRyxDQUFDTyxNQUFKLENBQVdDLFFBQXRDO0FBRUEsVUFBTUMsT0FBTyxHQUFHO0FBQ2RM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IGZyb20gJy4uL1Byb21pc2VSb3V0ZXInO1xuaW1wb3J0IHsgbG9hZEFkYXB0ZXIgfSBmcm9tICcuLi9BZGFwdGVycy9BZGFwdGVyTG9hZGVyJztcbmltcG9ydCByZXN0IGZyb20gJy4uL3Jlc3QnO1xuaW1wb3J0IGFyY2hpdmVyIGZyb20gJ2FyY2hpdmVyJztcbmltcG9ydCB0bXAgZnJvbSAndG1wJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5cbmNvbnN0IERlZmF1bHRFeHBvcnRFeHBvcnRQcm9ncmVzc0NvbGxlY3Rpb25OYW1lID0gJ19FeHBvcnRQcm9ncmVzcyc7XG5jb25zdCByZWxhdGlvblNjaGVtYSA9IHtcbiAgZmllbGRzOiB7IHJlbGF0ZWRJZDogeyB0eXBlOiAnU3RyaW5nJyB9LCBvd25pbmdJZDogeyB0eXBlOiAnU3RyaW5nJyB9IH0sXG59O1xuXG5leHBvcnQgY2xhc3MgRXhwb3J0Um91dGVyIGV4dGVuZHMgUHJvbWlzZVJvdXRlciB7XG4gIGV4cG9ydENsYXNzUGFnZShyZXEsIGNsYXNzTmFtZSwganNvbkZpbGVTdHJlYW0sIHdoZXJlLCBza2lwLCBsaW1pdCkge1xuICAgIGNvbnN0IGRhdGFiYXNlQ29udHJvbGxlciA9IHJlcS5jb25maWcuZGF0YWJhc2U7XG5cbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgc2tpcCxcbiAgICAgIGxpbWl0LFxuICAgIH07XG5cbiAgICBjb25zdCBmaW5kUHJvbWlzZSA9XG4gICAgICBjbGFzc05hbWUuaW5kZXhPZignX0pvaW4nKSA9PT0gMFxuICAgICAgICA/IGRhdGFiYXNlQ29udHJvbGxlci5hZGFwdGVyLmZpbmQoXG4gICAgICAgICAgY2xhc3NOYW1lLFxuICAgICAgICAgIHJlbGF0aW9uU2NoZW1hLFxuICAgICAgICAgIHdoZXJlLFxuICAgICAgICAgIG9wdGlvbnNcbiAgICAgICAgKVxuICAgICAgICA6IHJlc3QuZmluZChyZXEuY29uZmlnLCByZXEuYXV0aCwgY2xhc3NOYW1lLCB3aGVyZSwgb3B0aW9ucyk7XG5cbiAgICByZXR1cm4gZmluZFByb21pc2UudGhlbihkYXRhID0+IHtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XG4gICAgICAgIGRhdGEgPSB7XG4gICAgICAgICAgcmVzdWx0czogZGF0YS5tYXAob2JqID0+IHtcbiAgICAgICAgICAgIC8vIE5lZWRlZCB0byBhdm9pZCBlcnJvcnMgZHVyaW5nIGltcG9ydC5cbiAgICAgICAgICAgIC8vIFNlZSBtb3JlOiBodHRwczovL2RvY3MucGFyc2VwbGF0Zm9ybS5vcmcvanMvZ3VpZGUvI2Vycm9yLWNvZGVzXG5cbiAgICAgICAgICAgIC8vIERlbGV0ZXMgaW52YWxpZCBrZXlzIGluIG9yZGVyIHRvIGF2b2lkIFwiUGFyc2VFcnJvcjogMTA1IEludmFsaWQgZmllbGQgbmFtZVwiXG4gICAgICAgICAgICAvLyB3aGVuIGltcG9ydGluZ1xuICAgICAgICAgICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnXycpKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIG9ialtrZXldO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgfSksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGlmIChza2lwICYmIGRhdGEucmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAganNvbkZpbGVTdHJlYW0ud3JpdGUoJyxcXG4nKTtcbiAgICAgIH1cblxuICAgICAganNvbkZpbGVTdHJlYW0ud3JpdGUoXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KGRhdGEucmVzdWx0cywgbnVsbCwgMilcbiAgICAgICAgICAuc3Vic3RyKDEpXG4gICAgICAgICAgLnNsaWNlKDAsIC0xKVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIGV4cG9ydENsYXNzKHJlcSwgZGF0YSkge1xuICAgIGNvbnN0IGRhdGFiYXNlQ29udHJvbGxlciA9IHJlcS5jb25maWcuZGF0YWJhc2U7XG4gICAgY29uc3QgdG1wSnNvbkZpbGUgPSB0bXAuZmlsZVN5bmMoKTtcbiAgICBjb25zdCBqc29uRmlsZVN0cmVhbSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHRtcEpzb25GaWxlLm5hbWUpO1xuXG4gICAganNvbkZpbGVTdHJlYW0ud3JpdGUoJ3tcXG5cInJlc3VsdHNcIiA6IFtcXG4nKTtcbiAgICBjb25zdCBoYXNKb2luID0gZGF0YS5uYW1lLmluZGV4T2YoJ19Kb2luJykgPT09IDA7XG4gICAgbGV0IGZpbmRQcm9taXNlID0gbnVsbDtcbiAgICBpZiAoaGFzSm9pbikge1xuICAgICAgZmluZFByb21pc2UgPSBkYXRhYmFzZUNvbnRyb2xsZXIuYWRhcHRlci5jb3VudChcbiAgICAgICAgZGF0YS5uYW1lLFxuICAgICAgICByZWxhdGlvblNjaGVtYSxcbiAgICAgICAgZGF0YS53aGVyZVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmluZFByb21pc2UgPSByZXN0LmZpbmQocmVxLmNvbmZpZywgcmVxLmF1dGgsIGRhdGEubmFtZSwgZGF0YS53aGVyZSwge1xuICAgICAgICBjb3VudDogdHJ1ZSxcbiAgICAgICAgbGltaXQ6IDAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmluZFByb21pc2VcbiAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKHJlc3VsdCkpIHtcbiAgICAgICAgICByZXN1bHQgPSB7IGNvdW50OiByZXN1bHQgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpID0gMDtcbiAgICAgICAgY29uc3QgcGFnZUxpbWl0ID0gMTAwMDtcbiAgICAgICAgbGV0IHByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoKTtcblxuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcmVzdWx0LmNvdW50OyBpICs9IHBhZ2VMaW1pdCkge1xuICAgICAgICAgIGNvbnN0IHNraXAgPSBpO1xuICAgICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXhwb3J0Q2xhc3NQYWdlKFxuICAgICAgICAgICAgICByZXEsXG4gICAgICAgICAgICAgIGRhdGEubmFtZSxcbiAgICAgICAgICAgICAganNvbkZpbGVTdHJlYW0sXG4gICAgICAgICAgICAgIGRhdGEud2hlcmUsXG4gICAgICAgICAgICAgIHNraXAsXG4gICAgICAgICAgICAgIHBhZ2VMaW1pdFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAganNvbkZpbGVTdHJlYW0uZW5kKCddXFxufScpO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICBqc29uRmlsZVN0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgICB0bXBKc29uRmlsZS5fbmFtZSA9IGAke2RhdGEubmFtZS5yZXBsYWNlKC86L2csICfqnoknKX0uanNvbmA7XG5cbiAgICAgICAgICAgIHJlc29sdmUodG1wSnNvbkZpbGUpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlRXhwb3J0UHJvZ3Jlc3MocmVxKSB7XG4gICAgY29uc3QgZGF0YWJhc2VDb250cm9sbGVyID0gcmVxLmNvbmZpZy5kYXRhYmFzZTtcblxuICAgIGNvbnN0IHF1ZXJ5ID0ge1xuICAgICAgbWFzdGVyS2V5OiByZXEuaW5mby5tYXN0ZXJLZXksXG4gICAgICBhcHBsaWNhdGlvbklkOiByZXEuaW5mby5hcHBJZCxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGRhdGFiYXNlQ29udHJvbGxlclxuICAgICAgLmZpbmQoRGVmYXVsdEV4cG9ydEV4cG9ydFByb2dyZXNzQ29sbGVjdGlvbk5hbWUsIHF1ZXJ5KVxuICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICByZXR1cm4geyByZXNwb25zZSB9O1xuICAgICAgfSk7XG4gIH1cblxuICBoYW5kbGVFeHBvcnQocmVxKSB7XG4gICAgY29uc3QgZGF0YWJhc2VDb250cm9sbGVyID0gcmVxLmNvbmZpZy5kYXRhYmFzZTtcblxuICAgIGNvbnN0IGVtYWlsQ29udHJvbGxlckFkYXB0ZXIgPSBsb2FkQWRhcHRlcihyZXEuY29uZmlnLmVtYWlsQWRhcHRlcik7XG5cbiAgICBpZiAoIWVtYWlsQ29udHJvbGxlckFkYXB0ZXIpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ1lvdSBoYXZlIHRvIHNldHVwIGEgTWFpbCBBZGFwdGVyLicpKTtcbiAgICB9XG5cbiAgICBjb25zdCBleHBvcnRQcm9ncmVzcyA9IHtcbiAgICAgIGlkOiByZXEuYm9keS5uYW1lLFxuICAgICAgbWFzdGVyS2V5OiByZXEuaW5mby5tYXN0ZXJLZXksXG4gICAgICBhcHBsaWNhdGlvbklkOiByZXEuaW5mby5hcHBJZCxcbiAgICB9O1xuXG4gICAgZGF0YWJhc2VDb250cm9sbGVyXG4gICAgICAuY3JlYXRlKERlZmF1bHRFeHBvcnRFeHBvcnRQcm9ncmVzc0NvbGxlY3Rpb25OYW1lLCBleHBvcnRQcm9ncmVzcylcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIGRhdGFiYXNlQ29udHJvbGxlci5sb2FkU2NoZW1hKHsgY2xlYXJDYWNoZTogdHJ1ZSB9KTtcbiAgICAgIH0pXG4gICAgICAudGhlbihzY2hlbWFDb250cm9sbGVyID0+XG4gICAgICAgIHNjaGVtYUNvbnRyb2xsZXIuZ2V0T25lU2NoZW1hKHJlcS5ib2R5Lm5hbWUsIHRydWUpXG4gICAgICApXG4gICAgICAudGhlbihzY2hlbWEgPT4ge1xuICAgICAgICBjb25zdCBjbGFzc05hbWVzID0gW3JlcS5ib2R5Lm5hbWVdO1xuICAgICAgICBPYmplY3Qua2V5cyhzY2hlbWEuZmllbGRzKS5mb3JFYWNoKGZpZWxkTmFtZSA9PiB7XG4gICAgICAgICAgY29uc3QgZmllbGQgPSBzY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV07XG5cbiAgICAgICAgICBpZiAoZmllbGQudHlwZSA9PT0gJ1JlbGF0aW9uJykge1xuICAgICAgICAgICAgY2xhc3NOYW1lcy5wdXNoKGBfSm9pbjoke2ZpZWxkTmFtZX06JHtyZXEuYm9keS5uYW1lfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgcHJvbWlzc2VzID0gY2xhc3NOYW1lcy5tYXAobmFtZSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZXhwb3J0Q2xhc3MocmVxLCB7IG5hbWUgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNzZXMpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKGpzb25GaWxlcyA9PiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICBjb25zdCB0bXBaaXBGaWxlID0gdG1wLmZpbGVTeW5jKCk7XG4gICAgICAgICAgY29uc3QgdG1wWmlwU3RyZWFtID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0odG1wWmlwRmlsZS5uYW1lKTtcblxuICAgICAgICAgIGNvbnN0IHppcCA9IGFyY2hpdmVyKCd6aXAnKTtcbiAgICAgICAgICB6aXAucGlwZSh0bXBaaXBTdHJlYW0pO1xuXG4gICAgICAgICAganNvbkZpbGVzLmZvckVhY2godG1wSnNvbkZpbGUgPT4ge1xuICAgICAgICAgICAgemlwLmFwcGVuZChmcy5yZWFkRmlsZVN5bmModG1wSnNvbkZpbGUubmFtZSksIHtcbiAgICAgICAgICAgICAgbmFtZTogdG1wSnNvbkZpbGUuX25hbWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRtcEpzb25GaWxlLnJlbW92ZUNhbGxiYWNrKCk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICB6aXAuZmluYWxpemUoKTtcblxuICAgICAgICAgIHRtcFppcFN0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBidWYgPSBmcy5yZWFkRmlsZVN5bmModG1wWmlwRmlsZS5uYW1lKTtcbiAgICAgICAgICAgIHRtcFppcEZpbGUucmVtb3ZlQ2FsbGJhY2soKTtcbiAgICAgICAgICAgIHJlc29sdmUoYnVmKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oemlwcGVkRmlsZSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVzQ29udHJvbGxlciA9IHJlcS5jb25maWcuZmlsZXNDb250cm9sbGVyO1xuICAgICAgICByZXR1cm4gZmlsZXNDb250cm9sbGVyLmNyZWF0ZUZpbGUoXG4gICAgICAgICAgcmVxLmNvbmZpZyxcbiAgICAgICAgICByZXEuYm9keS5uYW1lLFxuICAgICAgICAgIHppcHBlZEZpbGUsXG4gICAgICAgICAgJ2FwcGxpY2F0aW9uL3ppcCdcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihmaWxlRGF0YSA9PiB7XG4gICAgICAgIHJldHVybiBlbWFpbENvbnRyb2xsZXJBZGFwdGVyLnNlbmRNYWlsKHtcbiAgICAgICAgICB0ZXh0OiBgV2UgaGF2ZSBzdWNjZXNzZnVsbHkgZXhwb3J0ZWQgeW91ciBkYXRhIGZyb20gdGhlIGNsYXNzICR7cmVxLmJvZHkubmFtZX0uXFxuXG4gICAgICAgIFBsZWFzZSBkb3dubG9hZCBmcm9tICR7ZmlsZURhdGEudXJsfWAsXG4gICAgICAgICAgbGluazogZmlsZURhdGEudXJsLFxuICAgICAgICAgIHRvOiByZXEuYm9keS5mZWVkYmFja0VtYWlsLFxuICAgICAgICAgIHN1YmplY3Q6ICdFeHBvcnQgY29tcGxldGVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgcmV0dXJuIGVtYWlsQ29udHJvbGxlckFkYXB0ZXIuc2VuZE1haWwoe1xuICAgICAgICAgIHRleHQ6IGBXZSBjb3VsZCBub3QgZXhwb3J0IHlvdXIgZGF0YSB0byB0aGUgY2xhc3MgJHtyZXEuYm9keS5uYW1lfS4gRXJyb3I6ICR7ZXJyb3J9YCxcbiAgICAgICAgICB0bzogcmVxLmJvZHkuZmVlZGJhY2tFbWFpbCxcbiAgICAgICAgICBzdWJqZWN0OiAnRXhwb3J0IGZhaWxlZCcsXG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIGRhdGFiYXNlQ29udHJvbGxlci5kZXN0cm95KFxuICAgICAgICAgIERlZmF1bHRFeHBvcnRFeHBvcnRQcm9ncmVzc0NvbGxlY3Rpb25OYW1lLFxuICAgICAgICAgIGV4cG9ydFByb2dyZXNzXG4gICAgICAgICk7XG4gICAgICB9KTtcblxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgcmVzcG9uc2U6XG4gICAgICAgICdXZSBhcmUgZXhwb3J0aW5nIHlvdXIgZGF0YS4gWW91IHdpbGwgYmUgbm90aWZpZWQgYnkgZS1tYWlsIG9uY2UgaXQgaXMgY29tcGxldGVkLicsXG4gICAgfSk7XG4gIH1cblxuICBtb3VudFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlKCdQVVQnLCAnL2V4cG9ydF9kYXRhJywgcmVxID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmhhbmRsZUV4cG9ydChyZXEpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgJy9leHBvcnRfcHJvZ3Jlc3MnLCByZXEgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlRXhwb3J0UHJvZ3Jlc3MocmVxKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBFeHBvcnRSb3V0ZXI7XG4iXX0=