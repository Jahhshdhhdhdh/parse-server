"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.PushController = void 0;
var _node = require("parse/node");
var _RestQuery = _interopRequireDefault(require("../RestQuery"));
var _RestWrite = _interopRequireDefault(require("../RestWrite"));
var _Auth = require("../Auth");
var _StatusHandler = require("../StatusHandler");
var _utils = require("../Push/utils");
var _logger = require("../logger");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
class PushController {
  sendPush(body = {}, where = {}, config, auth, onPushStatusSaved = () => {}, now = new Date()) {
    if (!config.hasPushSupport) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Missing push configuration');
    }

    // Replace the expiration_time and push_time with a valid Unix epoch milliseconds time
    body.expiration_time = PushController.getExpirationTime(body);
    body.expiration_interval = PushController.getExpirationInterval(body);
    if (body.expiration_time && body.expiration_interval) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Both expiration_time and expiration_interval cannot be set');
    }

    // Immediate push
    if (body.expiration_interval && !Object.prototype.hasOwnProperty.call(body, 'push_time')) {
      const ttlMs = body.expiration_interval * 1000;
      body.expiration_time = new Date(now.valueOf() + ttlMs).valueOf();
    }
    const pushTime = PushController.getPushTime(body);
    if (pushTime && pushTime.date !== 'undefined') {
      body['push_time'] = PushController.formatPushTime(pushTime);
    }

    // TODO: If the req can pass the checking, we return immediately instead of waiting
    // pushes to be sent. We probably change this behaviour in the future.
    let badgeUpdate = () => {
      return Promise.resolve();
    };
    if (body.data && body.data.badge) {
      const badge = body.data.badge;
      let restUpdate = {};
      if (typeof badge == 'string' && badge.toLowerCase() === 'increment') {
        restUpdate = {
          badge: {
            __op: 'Increment',
            amount: 1
          }
        };
      } else if (typeof badge == 'object' && typeof badge.__op == 'string' && badge.__op.toLowerCase() == 'increment' && Number(badge.amount)) {
        restUpdate = {
          badge: {
            __op: 'Increment',
            amount: badge.amount
          }
        };
      } else if (Number(badge)) {
        restUpdate = {
          badge: badge
        };
      } else {
        throw "Invalid value for badge, expected number or 'Increment' or {increment: number}";
      }

      // Force filtering on only valid device tokens
      const updateWhere = (0, _utils.applyDeviceTokenExists)(where);
      badgeUpdate = () => {
        // Build a real RestQuery so we can use it in RestWrite
        const restQuery = new _RestQuery.default(config, (0, _Auth.master)(config), '_Installation', updateWhere);
        return restQuery.buildRestWhere().then(() => {
          const write = new _RestWrite.default(config, (0, _Auth.master)(config), '_Installation', restQuery.restWhere, restUpdate);
          write.runOptions.many = true;
          return write.execute();
        });
      };
    }
    const pushStatus = (0, _StatusHandler.pushStatusHandler)(config);
    return Promise.resolve().then(() => {
      return pushStatus.setInitial(body, where);
    }).then(() => {
      onPushStatusSaved(pushStatus.objectId);
      return badgeUpdate().catch(err => {
        // add this to ignore badge update errors as default
        if (config.stopOnBadgeUpdateError) throw err;
        _logger.logger.info(`Badge update error will be ignored for push status ${pushStatus.objectId}`);
        _logger.logger.info(err && err.stack && err.stack.toString() || err && err.message || err.toString());
        return Promise.resolve();
      });
    }).then(() => {
      // Update audience lastUsed and timesUsed
      if (body.audience_id) {
        const audienceId = body.audience_id;
        var updateAudience = {
          lastUsed: {
            __type: 'Date',
            iso: new Date().toISOString()
          },
          timesUsed: {
            __op: 'Increment',
            amount: 1
          }
        };
        const write = new _RestWrite.default(config, (0, _Auth.master)(config), '_Audience', {
          objectId: audienceId
        }, updateAudience);
        write.execute();
      }
      // Don't wait for the audience update promise to resolve.
      return Promise.resolve();
    }).then(() => {
      if (Object.prototype.hasOwnProperty.call(body, 'push_time') && config.hasPushScheduledSupport) {
        return Promise.resolve();
      }
      return config.pushControllerQueue.enqueue(body, where, config, auth, pushStatus);
    }).catch(err => {
      return pushStatus.fail(err).then(() => {
        throw err;
      });
    });
  }

  /**
   * Get expiration time from the request body.
   * @param {Object} request A request object
   * @returns {Number|undefined} The expiration time if it exists in the request
   */
  static getExpirationTime(body = {}) {
    var hasExpirationTime = Object.prototype.hasOwnProperty.call(body, 'expiration_time');
    if (!hasExpirationTime) {
      return;
    }
    var expirationTimeParam = body['expiration_time'];
    var expirationTime;
    if (typeof expirationTimeParam === 'number') {
      expirationTime = new Date(expirationTimeParam * 1000);
    } else if (typeof expirationTimeParam === 'string') {
      expirationTime = new Date(expirationTimeParam);
    } else {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['expiration_time'] + ' is not valid time.');
    }
    // Check expirationTime is valid or not, if it is not valid, expirationTime is NaN
    if (!isFinite(expirationTime)) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['expiration_time'] + ' is not valid time.');
    }
    return expirationTime.valueOf();
  }
  static getExpirationInterval(body = {}) {
    const hasExpirationInterval = Object.prototype.hasOwnProperty.call(body, 'expiration_interval');
    if (!hasExpirationInterval) {
      return;
    }
    var expirationIntervalParam = body['expiration_interval'];
    if (typeof expirationIntervalParam !== 'number' || expirationIntervalParam <= 0) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, `expiration_interval must be a number greater than 0`);
    }
    return expirationIntervalParam;
  }

  /**
   * Get push time from the request body.
   * @param {Object} request A request object
   * @returns {Number|undefined} The push time if it exists in the request
   */
  static getPushTime(body = {}) {
    var hasPushTime = Object.prototype.hasOwnProperty.call(body, 'push_time');
    if (!hasPushTime) {
      return;
    }
    var pushTimeParam = body['push_time'];
    var date;
    var isLocalTime = true;
    if (typeof pushTimeParam === 'number') {
      date = new Date(pushTimeParam * 1000);
    } else if (typeof pushTimeParam === 'string') {
      isLocalTime = !PushController.pushTimeHasTimezoneComponent(pushTimeParam);
      date = new Date(pushTimeParam);
    } else {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['push_time'] + ' is not valid time.');
    }
    // Check pushTime is valid or not, if it is not valid, pushTime is NaN
    if (!isFinite(date)) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['push_time'] + ' is not valid time.');
    }
    return {
      date,
      isLocalTime
    };
  }

  /**
   * Checks if a ISO8601 formatted date contains a timezone component
   * @param pushTimeParam {string}
   * @returns {boolean}
   */
  static pushTimeHasTimezoneComponent(pushTimeParam) {
    const offsetPattern = /(.+)([+-])\d\d:\d\d$/;
    return pushTimeParam.indexOf('Z') === pushTimeParam.length - 1 || offsetPattern.test(pushTimeParam) // 2007-04-05T12:30Z
    ; // 2007-04-05T12:30.000+02:00, 2007-04-05T12:30.000-02:00
  }

  /**
   * Converts a date to ISO format in UTC time and strips the timezone if `isLocalTime` is true
   * @param date {Date}
   * @param isLocalTime {boolean}
   * @returns {string}
   */
  static formatPushTime({
    date,
    isLocalTime
  }) {
    if (isLocalTime) {
      // Strip 'Z'
      const isoString = date.toISOString();
      return isoString.substring(0, isoString.indexOf('Z'));
    }
    return date.toISOString();
  }
}
exports.PushController = PushController;
var _default = PushController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbm9kZSIsInJlcXVpcmUiLCJfUmVzdFF1ZXJ5IiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsIl9SZXN0V3JpdGUiLCJfQXV0aCIsIl9TdGF0dXNIYW5kbGVyIiwiX3V0aWxzIiwiX2xvZ2dlciIsIm9iaiIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiUHVzaENvbnRyb2xsZXIiLCJzZW5kUHVzaCIsImJvZHkiLCJ3aGVyZSIsImNvbmZpZyIsImF1dGgiLCJvblB1c2hTdGF0dXNTYXZlZCIsIm5vdyIsIkRhdGUiLCJoYXNQdXNoU3VwcG9ydCIsIlBhcnNlIiwiRXJyb3IiLCJQVVNIX01JU0NPTkZJR1VSRUQiLCJleHBpcmF0aW9uX3RpbWUiLCJnZXRFeHBpcmF0aW9uVGltZSIsImV4cGlyYXRpb25faW50ZXJ2YWwiLCJnZXRFeHBpcmF0aW9uSW50ZXJ2YWwiLCJPYmplY3QiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJ0dGxNcyIsInZhbHVlT2YiLCJwdXNoVGltZSIsImdldFB1c2hUaW1lIiwiZGF0ZSIsImZvcm1hdFB1c2hUaW1lIiwiYmFkZ2VVcGRhdGUiLCJQcm9taXNlIiwicmVzb2x2ZSIsImRhdGEiLCJiYWRnZSIsInJlc3RVcGRhdGUiLCJ0b0xvd2VyQ2FzZSIsIl9fb3AiLCJhbW91bnQiLCJOdW1iZXIiLCJ1cGRhdGVXaGVyZSIsImFwcGx5RGV2aWNlVG9rZW5FeGlzdHMiLCJyZXN0UXVlcnkiLCJSZXN0UXVlcnkiLCJtYXN0ZXIiLCJidWlsZFJlc3RXaGVyZSIsInRoZW4iLCJ3cml0ZSIsIlJlc3RXcml0ZSIsInJlc3RXaGVyZSIsInJ1bk9wdGlvbnMiLCJtYW55IiwiZXhlY3V0ZSIsInB1c2hTdGF0dXMiLCJwdXNoU3RhdHVzSGFuZGxlciIsInNldEluaXRpYWwiLCJvYmplY3RJZCIsImNhdGNoIiwiZXJyIiwic3RvcE9uQmFkZ2VVcGRhdGVFcnJvciIsImxvZ2dlciIsImluZm8iLCJzdGFjayIsInRvU3RyaW5nIiwibWVzc2FnZSIsImF1ZGllbmNlX2lkIiwiYXVkaWVuY2VJZCIsInVwZGF0ZUF1ZGllbmNlIiwibGFzdFVzZWQiLCJfX3R5cGUiLCJpc28iLCJ0b0lTT1N0cmluZyIsInRpbWVzVXNlZCIsImhhc1B1c2hTY2hlZHVsZWRTdXBwb3J0IiwicHVzaENvbnRyb2xsZXJRdWV1ZSIsImVucXVldWUiLCJmYWlsIiwiaGFzRXhwaXJhdGlvblRpbWUiLCJleHBpcmF0aW9uVGltZVBhcmFtIiwiZXhwaXJhdGlvblRpbWUiLCJpc0Zpbml0ZSIsImhhc0V4cGlyYXRpb25JbnRlcnZhbCIsImV4cGlyYXRpb25JbnRlcnZhbFBhcmFtIiwiaGFzUHVzaFRpbWUiLCJwdXNoVGltZVBhcmFtIiwiaXNMb2NhbFRpbWUiLCJwdXNoVGltZUhhc1RpbWV6b25lQ29tcG9uZW50Iiwib2Zmc2V0UGF0dGVybiIsImluZGV4T2YiLCJsZW5ndGgiLCJ0ZXN0IiwiaXNvU3RyaW5nIiwic3Vic3RyaW5nIiwiZXhwb3J0cyIsIl9kZWZhdWx0Il0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL0NvbnRyb2xsZXJzL1B1c2hDb250cm9sbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhcnNlIH0gZnJvbSAncGFyc2Uvbm9kZSc7XG5pbXBvcnQgUmVzdFF1ZXJ5IGZyb20gJy4uL1Jlc3RRdWVyeSc7XG5pbXBvcnQgUmVzdFdyaXRlIGZyb20gJy4uL1Jlc3RXcml0ZSc7XG5pbXBvcnQgeyBtYXN0ZXIgfSBmcm9tICcuLi9BdXRoJztcbmltcG9ydCB7IHB1c2hTdGF0dXNIYW5kbGVyIH0gZnJvbSAnLi4vU3RhdHVzSGFuZGxlcic7XG5pbXBvcnQgeyBhcHBseURldmljZVRva2VuRXhpc3RzIH0gZnJvbSAnLi4vUHVzaC91dGlscyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi9sb2dnZXInO1xuXG5leHBvcnQgY2xhc3MgUHVzaENvbnRyb2xsZXIge1xuICBzZW5kUHVzaChib2R5ID0ge30sIHdoZXJlID0ge30sIGNvbmZpZywgYXV0aCwgb25QdXNoU3RhdHVzU2F2ZWQgPSAoKSA9PiB7fSwgbm93ID0gbmV3IERhdGUoKSkge1xuICAgIGlmICghY29uZmlnLmhhc1B1c2hTdXBwb3J0KSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELCAnTWlzc2luZyBwdXNoIGNvbmZpZ3VyYXRpb24nKTtcbiAgICB9XG5cbiAgICAvLyBSZXBsYWNlIHRoZSBleHBpcmF0aW9uX3RpbWUgYW5kIHB1c2hfdGltZSB3aXRoIGEgdmFsaWQgVW5peCBlcG9jaCBtaWxsaXNlY29uZHMgdGltZVxuICAgIGJvZHkuZXhwaXJhdGlvbl90aW1lID0gUHVzaENvbnRyb2xsZXIuZ2V0RXhwaXJhdGlvblRpbWUoYm9keSk7XG4gICAgYm9keS5leHBpcmF0aW9uX2ludGVydmFsID0gUHVzaENvbnRyb2xsZXIuZ2V0RXhwaXJhdGlvbkludGVydmFsKGJvZHkpO1xuICAgIGlmIChib2R5LmV4cGlyYXRpb25fdGltZSAmJiBib2R5LmV4cGlyYXRpb25faW50ZXJ2YWwpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELFxuICAgICAgICAnQm90aCBleHBpcmF0aW9uX3RpbWUgYW5kIGV4cGlyYXRpb25faW50ZXJ2YWwgY2Fubm90IGJlIHNldCdcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gSW1tZWRpYXRlIHB1c2hcbiAgICBpZiAoYm9keS5leHBpcmF0aW9uX2ludGVydmFsICYmICFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYm9keSwgJ3B1c2hfdGltZScpKSB7XG4gICAgICBjb25zdCB0dGxNcyA9IGJvZHkuZXhwaXJhdGlvbl9pbnRlcnZhbCAqIDEwMDA7XG4gICAgICBib2R5LmV4cGlyYXRpb25fdGltZSA9IG5ldyBEYXRlKG5vdy52YWx1ZU9mKCkgKyB0dGxNcykudmFsdWVPZigpO1xuICAgIH1cblxuICAgIGNvbnN0IHB1c2hUaW1lID0gUHVzaENvbnRyb2xsZXIuZ2V0UHVzaFRpbWUoYm9keSk7XG4gICAgaWYgKHB1c2hUaW1lICYmIHB1c2hUaW1lLmRhdGUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBib2R5WydwdXNoX3RpbWUnXSA9IFB1c2hDb250cm9sbGVyLmZvcm1hdFB1c2hUaW1lKHB1c2hUaW1lKTtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBJZiB0aGUgcmVxIGNhbiBwYXNzIHRoZSBjaGVja2luZywgd2UgcmV0dXJuIGltbWVkaWF0ZWx5IGluc3RlYWQgb2Ygd2FpdGluZ1xuICAgIC8vIHB1c2hlcyB0byBiZSBzZW50LiBXZSBwcm9iYWJseSBjaGFuZ2UgdGhpcyBiZWhhdmlvdXIgaW4gdGhlIGZ1dHVyZS5cbiAgICBsZXQgYmFkZ2VVcGRhdGUgPSAoKSA9PiB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfTtcblxuICAgIGlmIChib2R5LmRhdGEgJiYgYm9keS5kYXRhLmJhZGdlKSB7XG4gICAgICBjb25zdCBiYWRnZSA9IGJvZHkuZGF0YS5iYWRnZTtcbiAgICAgIGxldCByZXN0VXBkYXRlID0ge307XG4gICAgICBpZiAodHlwZW9mIGJhZGdlID09ICdzdHJpbmcnICYmIGJhZGdlLnRvTG93ZXJDYXNlKCkgPT09ICdpbmNyZW1lbnQnKSB7XG4gICAgICAgIHJlc3RVcGRhdGUgPSB7IGJhZGdlOiB7IF9fb3A6ICdJbmNyZW1lbnQnLCBhbW91bnQ6IDEgfSB9O1xuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgdHlwZW9mIGJhZGdlID09ICdvYmplY3QnICYmXG4gICAgICAgIHR5cGVvZiBiYWRnZS5fX29wID09ICdzdHJpbmcnICYmXG4gICAgICAgIGJhZGdlLl9fb3AudG9Mb3dlckNhc2UoKSA9PSAnaW5jcmVtZW50JyAmJlxuICAgICAgICBOdW1iZXIoYmFkZ2UuYW1vdW50KVxuICAgICAgKSB7XG4gICAgICAgIHJlc3RVcGRhdGUgPSB7IGJhZGdlOiB7IF9fb3A6ICdJbmNyZW1lbnQnLCBhbW91bnQ6IGJhZGdlLmFtb3VudCB9IH07XG4gICAgICB9IGVsc2UgaWYgKE51bWJlcihiYWRnZSkpIHtcbiAgICAgICAgcmVzdFVwZGF0ZSA9IHsgYmFkZ2U6IGJhZGdlIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBcIkludmFsaWQgdmFsdWUgZm9yIGJhZGdlLCBleHBlY3RlZCBudW1iZXIgb3IgJ0luY3JlbWVudCcgb3Ige2luY3JlbWVudDogbnVtYmVyfVwiO1xuICAgICAgfVxuXG4gICAgICAvLyBGb3JjZSBmaWx0ZXJpbmcgb24gb25seSB2YWxpZCBkZXZpY2UgdG9rZW5zXG4gICAgICBjb25zdCB1cGRhdGVXaGVyZSA9IGFwcGx5RGV2aWNlVG9rZW5FeGlzdHMod2hlcmUpO1xuICAgICAgYmFkZ2VVcGRhdGUgPSAoKSA9PiB7XG4gICAgICAgIC8vIEJ1aWxkIGEgcmVhbCBSZXN0UXVlcnkgc28gd2UgY2FuIHVzZSBpdCBpbiBSZXN0V3JpdGVcbiAgICAgICAgY29uc3QgcmVzdFF1ZXJ5ID0gbmV3IFJlc3RRdWVyeShjb25maWcsIG1hc3Rlcihjb25maWcpLCAnX0luc3RhbGxhdGlvbicsIHVwZGF0ZVdoZXJlKTtcbiAgICAgICAgcmV0dXJuIHJlc3RRdWVyeS5idWlsZFJlc3RXaGVyZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHdyaXRlID0gbmV3IFJlc3RXcml0ZShcbiAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgIG1hc3Rlcihjb25maWcpLFxuICAgICAgICAgICAgJ19JbnN0YWxsYXRpb24nLFxuICAgICAgICAgICAgcmVzdFF1ZXJ5LnJlc3RXaGVyZSxcbiAgICAgICAgICAgIHJlc3RVcGRhdGVcbiAgICAgICAgICApO1xuICAgICAgICAgIHdyaXRlLnJ1bk9wdGlvbnMubWFueSA9IHRydWU7XG4gICAgICAgICAgcmV0dXJuIHdyaXRlLmV4ZWN1dGUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgIH1cbiAgICBjb25zdCBwdXNoU3RhdHVzID0gcHVzaFN0YXR1c0hhbmRsZXIoY29uZmlnKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIHB1c2hTdGF0dXMuc2V0SW5pdGlhbChib2R5LCB3aGVyZSk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBvblB1c2hTdGF0dXNTYXZlZChwdXNoU3RhdHVzLm9iamVjdElkKTtcbiAgICAgICAgcmV0dXJuIGJhZGdlVXBkYXRlKCkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAvLyBhZGQgdGhpcyB0byBpZ25vcmUgYmFkZ2UgdXBkYXRlIGVycm9ycyBhcyBkZWZhdWx0XG4gICAgICAgICAgaWYgKGNvbmZpZy5zdG9wT25CYWRnZVVwZGF0ZUVycm9yKSB0aHJvdyBlcnI7XG4gICAgICAgICAgbG9nZ2VyLmluZm8oXG4gICAgICAgICAgICBgQmFkZ2UgdXBkYXRlIGVycm9yIHdpbGwgYmUgaWdub3JlZCBmb3IgcHVzaCBzdGF0dXMgJHtwdXNoU3RhdHVzLm9iamVjdElkfWBcbiAgICAgICAgICApO1xuICAgICAgICAgIGxvZ2dlci5pbmZvKFxuICAgICAgICAgICAgKGVyciAmJiBlcnIuc3RhY2sgJiYgZXJyLnN0YWNrLnRvU3RyaW5nKCkpIHx8XG4gICAgICAgICAgICAgIChlcnIgJiYgZXJyLm1lc3NhZ2UpIHx8XG4gICAgICAgICAgICAgIGVyci50b1N0cmluZygpXG4gICAgICAgICAgKTtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgLy8gVXBkYXRlIGF1ZGllbmNlIGxhc3RVc2VkIGFuZCB0aW1lc1VzZWRcbiAgICAgICAgaWYgKGJvZHkuYXVkaWVuY2VfaWQpIHtcbiAgICAgICAgICBjb25zdCBhdWRpZW5jZUlkID0gYm9keS5hdWRpZW5jZV9pZDtcblxuICAgICAgICAgIHZhciB1cGRhdGVBdWRpZW5jZSA9IHtcbiAgICAgICAgICAgIGxhc3RVc2VkOiB7IF9fdHlwZTogJ0RhdGUnLCBpc286IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSB9LFxuICAgICAgICAgICAgdGltZXNVc2VkOiB7IF9fb3A6ICdJbmNyZW1lbnQnLCBhbW91bnQ6IDEgfSxcbiAgICAgICAgICB9O1xuICAgICAgICAgIGNvbnN0IHdyaXRlID0gbmV3IFJlc3RXcml0ZShcbiAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgIG1hc3Rlcihjb25maWcpLFxuICAgICAgICAgICAgJ19BdWRpZW5jZScsXG4gICAgICAgICAgICB7IG9iamVjdElkOiBhdWRpZW5jZUlkIH0sXG4gICAgICAgICAgICB1cGRhdGVBdWRpZW5jZVxuICAgICAgICAgICk7XG4gICAgICAgICAgd3JpdGUuZXhlY3V0ZSgpO1xuICAgICAgICB9XG4gICAgICAgIC8vIERvbid0IHdhaXQgZm9yIHRoZSBhdWRpZW5jZSB1cGRhdGUgcHJvbWlzZSB0byByZXNvbHZlLlxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGJvZHksICdwdXNoX3RpbWUnKSAmJlxuICAgICAgICAgIGNvbmZpZy5oYXNQdXNoU2NoZWR1bGVkU3VwcG9ydFxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbmZpZy5wdXNoQ29udHJvbGxlclF1ZXVlLmVucXVldWUoYm9keSwgd2hlcmUsIGNvbmZpZywgYXV0aCwgcHVzaFN0YXR1cyk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIHJldHVybiBwdXNoU3RhdHVzLmZhaWwoZXJyKS50aGVuKCgpID0+IHtcbiAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGV4cGlyYXRpb24gdGltZSBmcm9tIHRoZSByZXF1ZXN0IGJvZHkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXF1ZXN0IEEgcmVxdWVzdCBvYmplY3RcbiAgICogQHJldHVybnMge051bWJlcnx1bmRlZmluZWR9IFRoZSBleHBpcmF0aW9uIHRpbWUgaWYgaXQgZXhpc3RzIGluIHRoZSByZXF1ZXN0XG4gICAqL1xuICBzdGF0aWMgZ2V0RXhwaXJhdGlvblRpbWUoYm9keSA9IHt9KSB7XG4gICAgdmFyIGhhc0V4cGlyYXRpb25UaW1lID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGJvZHksICdleHBpcmF0aW9uX3RpbWUnKTtcbiAgICBpZiAoIWhhc0V4cGlyYXRpb25UaW1lKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBleHBpcmF0aW9uVGltZVBhcmFtID0gYm9keVsnZXhwaXJhdGlvbl90aW1lJ107XG4gICAgdmFyIGV4cGlyYXRpb25UaW1lO1xuICAgIGlmICh0eXBlb2YgZXhwaXJhdGlvblRpbWVQYXJhbSA9PT0gJ251bWJlcicpIHtcbiAgICAgIGV4cGlyYXRpb25UaW1lID0gbmV3IERhdGUoZXhwaXJhdGlvblRpbWVQYXJhbSAqIDEwMDApO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGV4cGlyYXRpb25UaW1lUGFyYW0gPT09ICdzdHJpbmcnKSB7XG4gICAgICBleHBpcmF0aW9uVGltZSA9IG5ldyBEYXRlKGV4cGlyYXRpb25UaW1lUGFyYW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgIFBhcnNlLkVycm9yLlBVU0hfTUlTQ09ORklHVVJFRCxcbiAgICAgICAgYm9keVsnZXhwaXJhdGlvbl90aW1lJ10gKyAnIGlzIG5vdCB2YWxpZCB0aW1lLidcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIENoZWNrIGV4cGlyYXRpb25UaW1lIGlzIHZhbGlkIG9yIG5vdCwgaWYgaXQgaXMgbm90IHZhbGlkLCBleHBpcmF0aW9uVGltZSBpcyBOYU5cbiAgICBpZiAoIWlzRmluaXRlKGV4cGlyYXRpb25UaW1lKSkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgIGJvZHlbJ2V4cGlyYXRpb25fdGltZSddICsgJyBpcyBub3QgdmFsaWQgdGltZS4nXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZXhwaXJhdGlvblRpbWUudmFsdWVPZigpO1xuICB9XG5cbiAgc3RhdGljIGdldEV4cGlyYXRpb25JbnRlcnZhbChib2R5ID0ge30pIHtcbiAgICBjb25zdCBoYXNFeHBpcmF0aW9uSW50ZXJ2YWwgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYm9keSwgJ2V4cGlyYXRpb25faW50ZXJ2YWwnKTtcbiAgICBpZiAoIWhhc0V4cGlyYXRpb25JbnRlcnZhbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHZhciBleHBpcmF0aW9uSW50ZXJ2YWxQYXJhbSA9IGJvZHlbJ2V4cGlyYXRpb25faW50ZXJ2YWwnXTtcbiAgICBpZiAodHlwZW9mIGV4cGlyYXRpb25JbnRlcnZhbFBhcmFtICE9PSAnbnVtYmVyJyB8fCBleHBpcmF0aW9uSW50ZXJ2YWxQYXJhbSA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgIFBhcnNlLkVycm9yLlBVU0hfTUlTQ09ORklHVVJFRCxcbiAgICAgICAgYGV4cGlyYXRpb25faW50ZXJ2YWwgbXVzdCBiZSBhIG51bWJlciBncmVhdGVyIHRoYW4gMGBcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBleHBpcmF0aW9uSW50ZXJ2YWxQYXJhbTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcHVzaCB0aW1lIGZyb20gdGhlIHJlcXVlc3QgYm9keS5cbiAgICogQHBhcmFtIHtPYmplY3R9IHJlcXVlc3QgQSByZXF1ZXN0IG9iamVjdFxuICAgKiBAcmV0dXJucyB7TnVtYmVyfHVuZGVmaW5lZH0gVGhlIHB1c2ggdGltZSBpZiBpdCBleGlzdHMgaW4gdGhlIHJlcXVlc3RcbiAgICovXG4gIHN0YXRpYyBnZXRQdXNoVGltZShib2R5ID0ge30pIHtcbiAgICB2YXIgaGFzUHVzaFRpbWUgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYm9keSwgJ3B1c2hfdGltZScpO1xuICAgIGlmICghaGFzUHVzaFRpbWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHB1c2hUaW1lUGFyYW0gPSBib2R5WydwdXNoX3RpbWUnXTtcbiAgICB2YXIgZGF0ZTtcbiAgICB2YXIgaXNMb2NhbFRpbWUgPSB0cnVlO1xuXG4gICAgaWYgKHR5cGVvZiBwdXNoVGltZVBhcmFtID09PSAnbnVtYmVyJykge1xuICAgICAgZGF0ZSA9IG5ldyBEYXRlKHB1c2hUaW1lUGFyYW0gKiAxMDAwKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwdXNoVGltZVBhcmFtID09PSAnc3RyaW5nJykge1xuICAgICAgaXNMb2NhbFRpbWUgPSAhUHVzaENvbnRyb2xsZXIucHVzaFRpbWVIYXNUaW1lem9uZUNvbXBvbmVudChwdXNoVGltZVBhcmFtKTtcbiAgICAgIGRhdGUgPSBuZXcgRGF0ZShwdXNoVGltZVBhcmFtKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgIGJvZHlbJ3B1c2hfdGltZSddICsgJyBpcyBub3QgdmFsaWQgdGltZS4nXG4gICAgICApO1xuICAgIH1cbiAgICAvLyBDaGVjayBwdXNoVGltZSBpcyB2YWxpZCBvciBub3QsIGlmIGl0IGlzIG5vdCB2YWxpZCwgcHVzaFRpbWUgaXMgTmFOXG4gICAgaWYgKCFpc0Zpbml0ZShkYXRlKSkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgIGJvZHlbJ3B1c2hfdGltZSddICsgJyBpcyBub3QgdmFsaWQgdGltZS4nXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBkYXRlLFxuICAgICAgaXNMb2NhbFRpbWUsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgYSBJU084NjAxIGZvcm1hdHRlZCBkYXRlIGNvbnRhaW5zIGEgdGltZXpvbmUgY29tcG9uZW50XG4gICAqIEBwYXJhbSBwdXNoVGltZVBhcmFtIHtzdHJpbmd9XG4gICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgKi9cbiAgc3RhdGljIHB1c2hUaW1lSGFzVGltZXpvbmVDb21wb25lbnQocHVzaFRpbWVQYXJhbTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgb2Zmc2V0UGF0dGVybiA9IC8oLispKFsrLV0pXFxkXFxkOlxcZFxcZCQvO1xuICAgIHJldHVybiAoXG4gICAgICBwdXNoVGltZVBhcmFtLmluZGV4T2YoJ1onKSA9PT0gcHVzaFRpbWVQYXJhbS5sZW5ndGggLSAxIHx8IG9mZnNldFBhdHRlcm4udGVzdChwdXNoVGltZVBhcmFtKSAvLyAyMDA3LTA0LTA1VDEyOjMwWlxuICAgICk7IC8vIDIwMDctMDQtMDVUMTI6MzAuMDAwKzAyOjAwLCAyMDA3LTA0LTA1VDEyOjMwLjAwMC0wMjowMFxuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnRzIGEgZGF0ZSB0byBJU08gZm9ybWF0IGluIFVUQyB0aW1lIGFuZCBzdHJpcHMgdGhlIHRpbWV6b25lIGlmIGBpc0xvY2FsVGltZWAgaXMgdHJ1ZVxuICAgKiBAcGFyYW0gZGF0ZSB7RGF0ZX1cbiAgICogQHBhcmFtIGlzTG9jYWxUaW1lIHtib29sZWFufVxuICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgKi9cbiAgc3RhdGljIGZvcm1hdFB1c2hUaW1lKHsgZGF0ZSwgaXNMb2NhbFRpbWUgfTogeyBkYXRlOiBEYXRlLCBpc0xvY2FsVGltZTogYm9vbGVhbiB9KSB7XG4gICAgaWYgKGlzTG9jYWxUaW1lKSB7XG4gICAgICAvLyBTdHJpcCAnWidcbiAgICAgIGNvbnN0IGlzb1N0cmluZyA9IGRhdGUudG9JU09TdHJpbmcoKTtcbiAgICAgIHJldHVybiBpc29TdHJpbmcuc3Vic3RyaW5nKDAsIGlzb1N0cmluZy5pbmRleE9mKCdaJykpO1xuICAgIH1cbiAgICByZXR1cm4gZGF0ZS50b0lTT1N0cmluZygpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFB1c2hDb250cm9sbGVyO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFBQSxLQUFBLEdBQUFDLE9BQUE7QUFDQSxJQUFBQyxVQUFBLEdBQUFDLHNCQUFBLENBQUFGLE9BQUE7QUFDQSxJQUFBRyxVQUFBLEdBQUFELHNCQUFBLENBQUFGLE9BQUE7QUFDQSxJQUFBSSxLQUFBLEdBQUFKLE9BQUE7QUFDQSxJQUFBSyxjQUFBLEdBQUFMLE9BQUE7QUFDQSxJQUFBTSxNQUFBLEdBQUFOLE9BQUE7QUFDQSxJQUFBTyxPQUFBLEdBQUFQLE9BQUE7QUFBbUMsU0FBQUUsdUJBQUFNLEdBQUEsV0FBQUEsR0FBQSxJQUFBQSxHQUFBLENBQUFDLFVBQUEsR0FBQUQsR0FBQSxLQUFBRSxPQUFBLEVBQUFGLEdBQUE7QUFFNUIsTUFBTUcsY0FBYyxDQUFDO0VBQzFCQyxRQUFRQSxDQUFDQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUVDLEtBQUssR0FBRyxDQUFDLENBQUMsRUFBRUMsTUFBTSxFQUFFQyxJQUFJLEVBQUVDLGlCQUFpQixHQUFHQSxDQUFBLEtBQU0sQ0FBQyxDQUFDLEVBQUVDLEdBQUcsR0FBRyxJQUFJQyxJQUFJLEVBQUUsRUFBRTtJQUM1RixJQUFJLENBQUNKLE1BQU0sQ0FBQ0ssY0FBYyxFQUFFO01BQzFC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