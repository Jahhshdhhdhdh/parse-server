"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.LoggerController = exports.LogOrder = exports.LogLevel = void 0;
var _node = require("parse/node");
var _AdaptableController = _interopRequireDefault(require("./AdaptableController"));
var _LoggerAdapter = require("../Adapters/Logger/LoggerAdapter");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const MILLISECONDS_IN_A_DAY = 24 * 60 * 60 * 1000;
const LOG_STRING_TRUNCATE_LENGTH = 1000;
const truncationMarker = '... (truncated)';
const LogLevel = {
  INFO: 'info',
  ERROR: 'error'
};
exports.LogLevel = LogLevel;
const LogOrder = {
  DESCENDING: 'desc',
  ASCENDING: 'asc'
};
exports.LogOrder = LogOrder;
const logLevels = ['error', 'warn', 'info', 'debug', 'verbose', 'silly'];
class LoggerController extends _AdaptableController.default {
  constructor(adapter, appId, options = {
    logLevel: 'info'
  }) {
    super(adapter, appId, options);
    let level = 'info';
    if (options.verbose) {
      level = 'verbose';
    }
    if (options.logLevel) {
      level = options.logLevel;
    }
    const index = logLevels.indexOf(level); // info by default
    logLevels.forEach((level, levelIndex) => {
      if (levelIndex > index) {
        // silence the levels that are > maxIndex
        this[level] = () => {};
      }
    });
  }
  maskSensitiveUrl(path) {
    const urlString = 'http://localhost' + path; // prepend dummy string to make a real URL
    const urlObj = new URL(urlString);
    const query = urlObj.searchParams;
    let sanitizedQuery = '?';
    for (const [key, value] of query) {
      if (key !== 'password') {
        // normal value
        sanitizedQuery += key + '=' + value + '&';
      } else {
        // password value, redact it
        sanitizedQuery += key + '=' + '********' + '&';
      }
    }

    // trim last character, ? or &
    sanitizedQuery = sanitizedQuery.slice(0, -1);

    // return original path name with sanitized params attached
    return urlObj.pathname + sanitizedQuery;
  }
  maskSensitive(argArray) {
    return argArray.map(e => {
      if (!e) {
        return e;
      }
      if (typeof e === 'string') {
        return e.replace(/(password".?:.?")[^"]*"/g, '$1********"');
      }
      // else it is an object...

      // check the url
      if (e.url) {
        // for strings
        if (typeof e.url === 'string') {
          e.url = this.maskSensitiveUrl(e.url);
        } else if (Array.isArray(e.url)) {
          // for strings in array
          e.url = e.url.map(item => {
            if (typeof item === 'string') {
              return this.maskSensitiveUrl(item);
            }
            return item;
          });
        }
      }
      if (e.body) {
        for (const key of Object.keys(e.body)) {
          if (key === 'password') {
            e.body[key] = '********';
            break;
          }
        }
      }
      if (e.params) {
        for (const key of Object.keys(e.params)) {
          if (key === 'password') {
            e.params[key] = '********';
            break;
          }
        }
      }
      return e;
    });
  }
  log(level, args) {
    // make the passed in arguments object an array with the spread operator
    args = this.maskSensitive([...args]);
    args = [].concat(level, args.map(arg => {
      if (typeof arg === 'function') {
        return arg();
      }
      return arg;
    }));
    this.adapter.log.apply(this.adapter, args);
  }
  info() {
    return this.log('info', arguments);
  }
  error() {
    return this.log('error', arguments);
  }
  warn() {
    return this.log('warn', arguments);
  }
  verbose() {
    return this.log('verbose', arguments);
  }
  debug() {
    return this.log('debug', arguments);
  }
  silly() {
    return this.log('silly', arguments);
  }
  logRequest({
    method,
    url,
    headers,
    body
  }) {
    this.verbose(() => {
      const stringifiedBody = JSON.stringify(body, null, 2);
      return `REQUEST for [${method}] ${url}: ${stringifiedBody}`;
    }, {
      method,
      url,
      headers,
      body
    });
  }
  logResponse({
    method,
    url,
    result
  }) {
    this.verbose(() => {
      const stringifiedResponse = JSON.stringify(result, null, 2);
      return `RESPONSE from [${method}] ${url}: ${stringifiedResponse}`;
    }, {
      result: result
    });
  }
  // check that date input is valid
  static validDateTime(date) {
    if (!date) {
      return null;
    }
    date = new Date(date);
    if (!isNaN(date.getTime())) {
      return date;
    }
    return null;
  }
  truncateLogMessage(string) {
    if (string && string.length > LOG_STRING_TRUNCATE_LENGTH) {
      const truncated = string.substring(0, LOG_STRING_TRUNCATE_LENGTH) + truncationMarker;
      return truncated;
    }
    return string;
  }
  static parseOptions(options = {}) {
    const from = LoggerController.validDateTime(options.from) || new Date(Date.now() - 7 * MILLISECONDS_IN_A_DAY);
    const until = LoggerController.validDateTime(options.until) || new Date();
    const size = Number(options.size) || 10;
    const order = options.order || LogOrder.DESCENDING;
    const level = options.level || LogLevel.INFO;
    return {
      from,
      until,
      size,
      order,
      level
    };
  }

  // Returns a promise for a {response} object.
  // query params:
  // level (optional) Level of logging you want to query for (info || error)
  // from (optional) Start time for the search. Defaults to 1 week ago.
  // until (optional) End time for the search. Defaults to current time.
  // order (optional) Direction of results returned, either “asc” or “desc”. Defaults to “desc”.
  // size (optional) Number of rows returned by search. Defaults to 10
  getLogs(options = {}) {
    if (!this.adapter) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Logger adapter is not available');
    }
    if (typeof this.adapter.query !== 'function') {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Querying logs is not supported with this adapter');
    }
    options = LoggerController.parseOptions(options);
    return this.adapter.query(options);
  }
  expectedAdapterType() {
    return _LoggerAdapter.LoggerAdapter;
  }
}
exports.LoggerController = LoggerController;
var _default = LoggerController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbm9kZSIsInJlcXVpcmUiLCJfQWRhcHRhYmxlQ29udHJvbGxlciIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJfTG9nZ2VyQWRhcHRlciIsIm9iaiIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiTUlMTElTRUNPTkRTX0lOX0FfREFZIiwiTE9HX1NUUklOR19UUlVOQ0FURV9MRU5HVEgiLCJ0cnVuY2F0aW9uTWFya2VyIiwiTG9nTGV2ZWwiLCJJTkZPIiwiRVJST1IiLCJleHBvcnRzIiwiTG9nT3JkZXIiLCJERVNDRU5ESU5HIiwiQVNDRU5ESU5HIiwibG9nTGV2ZWxzIiwiTG9nZ2VyQ29udHJvbGxlciIsIkFkYXB0YWJsZUNvbnRyb2xsZXIiLCJjb25zdHJ1Y3RvciIsImFkYXB0ZXIiLCJhcHBJZCIsIm9wdGlvbnMiLCJsb2dMZXZlbCIsImxldmVsIiwidmVyYm9zZSIsImluZGV4IiwiaW5kZXhPZiIsImZvckVhY2giLCJsZXZlbEluZGV4IiwibWFza1NlbnNpdGl2ZVVybCIsInBhdGgiLCJ1cmxTdHJpbmciLCJ1cmxPYmoiLCJVUkwiLCJxdWVyeSIsInNlYXJjaFBhcmFtcyIsInNhbml0aXplZFF1ZXJ5Iiwia2V5IiwidmFsdWUiLCJzbGljZSIsInBhdGhuYW1lIiwibWFza1NlbnNpdGl2ZSIsImFyZ0FycmF5IiwibWFwIiwiZSIsInJlcGxhY2UiLCJ1cmwiLCJBcnJheSIsImlzQXJyYXkiLCJpdGVtIiwiYm9keSIsIk9iamVjdCIsImtleXMiLCJwYXJhbXMiLCJsb2ciLCJhcmdzIiwiY29uY2F0IiwiYXJnIiwiYXBwbHkiLCJpbmZvIiwiYXJndW1lbnRzIiwiZXJyb3IiLCJ3YXJuIiwiZGVidWciLCJzaWxseSIsImxvZ1JlcXVlc3QiLCJtZXRob2QiLCJoZWFkZXJzIiwic3RyaW5naWZpZWRCb2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsImxvZ1Jlc3BvbnNlIiwicmVzdWx0Iiwic3RyaW5naWZpZWRSZXNwb25zZSIsInZhbGlkRGF0ZVRpbWUiLCJkYXRlIiwiRGF0ZSIsImlzTmFOIiwiZ2V0VGltZSIsInRydW5jYXRlTG9nTWVzc2FnZSIsInN0cmluZyIsImxlbmd0aCIsInRydW5jYXRlZCIsInN1YnN0cmluZyIsInBhcnNlT3B0aW9ucyIsImZyb20iLCJub3ciLCJ1bnRpbCIsInNpemUiLCJOdW1iZXIiLCJvcmRlciIsImdldExvZ3MiLCJQYXJzZSIsIkVycm9yIiwiUFVTSF9NSVNDT05GSUdVUkVEIiwiZXhwZWN0ZWRBZGFwdGVyVHlwZSIsIkxvZ2dlckFkYXB0ZXIiLCJfZGVmYXVsdCJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Db250cm9sbGVycy9Mb2dnZXJDb250cm9sbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhcnNlIH0gZnJvbSAncGFyc2Uvbm9kZSc7XG5pbXBvcnQgQWRhcHRhYmxlQ29udHJvbGxlciBmcm9tICcuL0FkYXB0YWJsZUNvbnRyb2xsZXInO1xuaW1wb3J0IHsgTG9nZ2VyQWRhcHRlciB9IGZyb20gJy4uL0FkYXB0ZXJzL0xvZ2dlci9Mb2dnZXJBZGFwdGVyJztcblxuY29uc3QgTUlMTElTRUNPTkRTX0lOX0FfREFZID0gMjQgKiA2MCAqIDYwICogMTAwMDtcbmNvbnN0IExPR19TVFJJTkdfVFJVTkNBVEVfTEVOR1RIID0gMTAwMDtcbmNvbnN0IHRydW5jYXRpb25NYXJrZXIgPSAnLi4uICh0cnVuY2F0ZWQpJztcblxuZXhwb3J0IGNvbnN0IExvZ0xldmVsID0ge1xuICBJTkZPOiAnaW5mbycsXG4gIEVSUk9SOiAnZXJyb3InLFxufTtcblxuZXhwb3J0IGNvbnN0IExvZ09yZGVyID0ge1xuICBERVNDRU5ESU5HOiAnZGVzYycsXG4gIEFTQ0VORElORzogJ2FzYycsXG59O1xuXG5jb25zdCBsb2dMZXZlbHMgPSBbJ2Vycm9yJywgJ3dhcm4nLCAnaW5mbycsICdkZWJ1ZycsICd2ZXJib3NlJywgJ3NpbGx5J107XG5cbmV4cG9ydCBjbGFzcyBMb2dnZXJDb250cm9sbGVyIGV4dGVuZHMgQWRhcHRhYmxlQ29udHJvbGxlciB7XG4gIGNvbnN0cnVjdG9yKGFkYXB0ZXIsIGFwcElkLCBvcHRpb25zID0geyBsb2dMZXZlbDogJ2luZm8nIH0pIHtcbiAgICBzdXBlcihhZGFwdGVyLCBhcHBJZCwgb3B0aW9ucyk7XG4gICAgbGV0IGxldmVsID0gJ2luZm8nO1xuICAgIGlmIChvcHRpb25zLnZlcmJvc2UpIHtcbiAgICAgIGxldmVsID0gJ3ZlcmJvc2UnO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5sb2dMZXZlbCkge1xuICAgICAgbGV2ZWwgPSBvcHRpb25zLmxvZ0xldmVsO1xuICAgIH1cbiAgICBjb25zdCBpbmRleCA9IGxvZ0xldmVscy5pbmRleE9mKGxldmVsKTsgLy8gaW5mbyBieSBkZWZhdWx0XG4gICAgbG9nTGV2ZWxzLmZvckVhY2goKGxldmVsLCBsZXZlbEluZGV4KSA9PiB7XG4gICAgICBpZiAobGV2ZWxJbmRleCA+IGluZGV4KSB7XG4gICAgICAgIC8vIHNpbGVuY2UgdGhlIGxldmVscyB0aGF0IGFyZSA+IG1heEluZGV4XG4gICAgICAgIHRoaXNbbGV2ZWxdID0gKCkgPT4ge307XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBtYXNrU2Vuc2l0aXZlVXJsKHBhdGgpIHtcbiAgICBjb25zdCB1cmxTdHJpbmcgPSAnaHR0cDovL2xvY2FsaG9zdCcgKyBwYXRoOyAvLyBwcmVwZW5kIGR1bW15IHN0cmluZyB0byBtYWtlIGEgcmVhbCBVUkxcbiAgICBjb25zdCB1cmxPYmogPSBuZXcgVVJMKHVybFN0cmluZyk7XG4gICAgY29uc3QgcXVlcnkgPSB1cmxPYmouc2VhcmNoUGFyYW1zO1xuICAgIGxldCBzYW5pdGl6ZWRRdWVyeSA9ICc/JztcblxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHF1ZXJ5KSB7XG4gICAgICBpZiAoa2V5ICE9PSAncGFzc3dvcmQnKSB7XG4gICAgICAgIC8vIG5vcm1hbCB2YWx1ZVxuICAgICAgICBzYW5pdGl6ZWRRdWVyeSArPSBrZXkgKyAnPScgKyB2YWx1ZSArICcmJztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHBhc3N3b3JkIHZhbHVlLCByZWRhY3QgaXRcbiAgICAgICAgc2FuaXRpemVkUXVlcnkgKz0ga2V5ICsgJz0nICsgJyoqKioqKioqJyArICcmJztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB0cmltIGxhc3QgY2hhcmFjdGVyLCA/IG9yICZcbiAgICBzYW5pdGl6ZWRRdWVyeSA9IHNhbml0aXplZFF1ZXJ5LnNsaWNlKDAsIC0xKTtcblxuICAgIC8vIHJldHVybiBvcmlnaW5hbCBwYXRoIG5hbWUgd2l0aCBzYW5pdGl6ZWQgcGFyYW1zIGF0dGFjaGVkXG4gICAgcmV0dXJuIHVybE9iai5wYXRobmFtZSArIHNhbml0aXplZFF1ZXJ5O1xuICB9XG5cbiAgbWFza1NlbnNpdGl2ZShhcmdBcnJheSkge1xuICAgIHJldHVybiBhcmdBcnJheS5tYXAoZSA9PiB7XG4gICAgICBpZiAoIWUpIHtcbiAgICAgICAgcmV0dXJuIGU7XG4gICAgICB9XG5cbiAgICAgIGlmICh0eXBlb2YgZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIGUucmVwbGFjZSgvKHBhc3N3b3JkXCIuPzouP1wiKVteXCJdKlwiL2csICckMSoqKioqKioqXCInKTtcbiAgICAgIH1cbiAgICAgIC8vIGVsc2UgaXQgaXMgYW4gb2JqZWN0Li4uXG5cbiAgICAgIC8vIGNoZWNrIHRoZSB1cmxcbiAgICAgIGlmIChlLnVybCkge1xuICAgICAgICAvLyBmb3Igc3RyaW5nc1xuICAgICAgICBpZiAodHlwZW9mIGUudXJsID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIGUudXJsID0gdGhpcy5tYXNrU2Vuc2l0aXZlVXJsKGUudXJsKTtcbiAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGUudXJsKSkge1xuICAgICAgICAgIC8vIGZvciBzdHJpbmdzIGluIGFycmF5XG4gICAgICAgICAgZS51cmwgPSBlLnVybC5tYXAoaXRlbSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLm1hc2tTZW5zaXRpdmVVcmwoaXRlbSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChlLmJvZHkpIHtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoZS5ib2R5KSkge1xuICAgICAgICAgIGlmIChrZXkgPT09ICdwYXNzd29yZCcpIHtcbiAgICAgICAgICAgIGUuYm9keVtrZXldID0gJyoqKioqKioqJztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoZS5wYXJhbXMpIHtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoZS5wYXJhbXMpKSB7XG4gICAgICAgICAgaWYgKGtleSA9PT0gJ3Bhc3N3b3JkJykge1xuICAgICAgICAgICAgZS5wYXJhbXNba2V5XSA9ICcqKioqKioqKic7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGU7XG4gICAgfSk7XG4gIH1cblxuICBsb2cobGV2ZWwsIGFyZ3MpIHtcbiAgICAvLyBtYWtlIHRoZSBwYXNzZWQgaW4gYXJndW1lbnRzIG9iamVjdCBhbiBhcnJheSB3aXRoIHRoZSBzcHJlYWQgb3BlcmF0b3JcbiAgICBhcmdzID0gdGhpcy5tYXNrU2Vuc2l0aXZlKFsuLi5hcmdzXSk7XG4gICAgYXJncyA9IFtdLmNvbmNhdChcbiAgICAgIGxldmVsLFxuICAgICAgYXJncy5tYXAoYXJnID0+IHtcbiAgICAgICAgaWYgKHR5cGVvZiBhcmcgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICByZXR1cm4gYXJnKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFyZztcbiAgICAgIH0pXG4gICAgKTtcbiAgICB0aGlzLmFkYXB0ZXIubG9nLmFwcGx5KHRoaXMuYWRhcHRlciwgYXJncyk7XG4gIH1cblxuICBpbmZvKCkge1xuICAgIHJldHVybiB0aGlzLmxvZygnaW5mbycsIGFyZ3VtZW50cyk7XG4gIH1cblxuICBlcnJvcigpIHtcbiAgICByZXR1cm4gdGhpcy5sb2coJ2Vycm9yJywgYXJndW1lbnRzKTtcbiAgfVxuXG4gIHdhcm4oKSB7XG4gICAgcmV0dXJuIHRoaXMubG9nKCd3YXJuJywgYXJndW1lbnRzKTtcbiAgfVxuXG4gIHZlcmJvc2UoKSB7XG4gICAgcmV0dXJuIHRoaXMubG9nKCd2ZXJib3NlJywgYXJndW1lbnRzKTtcbiAgfVxuXG4gIGRlYnVnKCkge1xuICAgIHJldHVybiB0aGlzLmxvZygnZGVidWcnLCBhcmd1bWVudHMpO1xuICB9XG5cbiAgc2lsbHkoKSB7XG4gICAgcmV0dXJuIHRoaXMubG9nKCdzaWxseScsIGFyZ3VtZW50cyk7XG4gIH1cblxuICBsb2dSZXF1ZXN0KHsgbWV0aG9kLCB1cmwsIGhlYWRlcnMsIGJvZHkgfSkge1xuICAgIHRoaXMudmVyYm9zZShcbiAgICAgICgpID0+IHtcbiAgICAgICAgY29uc3Qgc3RyaW5naWZpZWRCb2R5ID0gSlNPTi5zdHJpbmdpZnkoYm9keSwgbnVsbCwgMik7XG4gICAgICAgIHJldHVybiBgUkVRVUVTVCBmb3IgWyR7bWV0aG9kfV0gJHt1cmx9OiAke3N0cmluZ2lmaWVkQm9keX1gO1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbWV0aG9kLFxuICAgICAgICB1cmwsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHksXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGxvZ1Jlc3BvbnNlKHsgbWV0aG9kLCB1cmwsIHJlc3VsdCB9KSB7XG4gICAgdGhpcy52ZXJib3NlKFxuICAgICAgKCkgPT4ge1xuICAgICAgICBjb25zdCBzdHJpbmdpZmllZFJlc3BvbnNlID0gSlNPTi5zdHJpbmdpZnkocmVzdWx0LCBudWxsLCAyKTtcbiAgICAgICAgcmV0dXJuIGBSRVNQT05TRSBmcm9tIFske21ldGhvZH1dICR7dXJsfTogJHtzdHJpbmdpZmllZFJlc3BvbnNlfWA7XG4gICAgICB9LFxuICAgICAgeyByZXN1bHQ6IHJlc3VsdCB9XG4gICAgKTtcbiAgfVxuICAvLyBjaGVjayB0aGF0IGRhdGUgaW5wdXQgaXMgdmFsaWRcbiAgc3RhdGljIHZhbGlkRGF0ZVRpbWUoZGF0ZSkge1xuICAgIGlmICghZGF0ZSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTtcblxuICAgIGlmICghaXNOYU4oZGF0ZS5nZXRUaW1lKCkpKSB7XG4gICAgICByZXR1cm4gZGF0ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHRydW5jYXRlTG9nTWVzc2FnZShzdHJpbmcpIHtcbiAgICBpZiAoc3RyaW5nICYmIHN0cmluZy5sZW5ndGggPiBMT0dfU1RSSU5HX1RSVU5DQVRFX0xFTkdUSCkge1xuICAgICAgY29uc3QgdHJ1bmNhdGVkID0gc3RyaW5nLnN1YnN0cmluZygwLCBMT0dfU1RSSU5HX1RSVU5DQVRFX0xFTkdUSCkgKyB0cnVuY2F0aW9uTWFya2VyO1xuICAgICAgcmV0dXJuIHRydW5jYXRlZDtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RyaW5nO1xuICB9XG5cbiAgc3RhdGljIHBhcnNlT3B0aW9ucyhvcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBmcm9tID1cbiAgICAgIExvZ2dlckNvbnRyb2xsZXIudmFsaWREYXRlVGltZShvcHRpb25zLmZyb20pIHx8XG4gICAgICBuZXcgRGF0ZShEYXRlLm5vdygpIC0gNyAqIE1JTExJU0VDT05EU19JTl9BX0RBWSk7XG4gICAgY29uc3QgdW50aWwgPSBMb2dnZXJDb250cm9sbGVyLnZhbGlkRGF0ZVRpbWUob3B0aW9ucy51bnRpbCkgfHwgbmV3IERhdGUoKTtcbiAgICBjb25zdCBzaXplID0gTnVtYmVyKG9wdGlvbnMuc2l6ZSkgfHwgMTA7XG4gICAgY29uc3Qgb3JkZXIgPSBvcHRpb25zLm9yZGVyIHx8IExvZ09yZGVyLkRFU0NFTkRJTkc7XG4gICAgY29uc3QgbGV2ZWwgPSBvcHRpb25zLmxldmVsIHx8IExvZ0xldmVsLklORk87XG5cbiAgICByZXR1cm4ge1xuICAgICAgZnJvbSxcbiAgICAgIHVudGlsLFxuICAgICAgc2l6ZSxcbiAgICAgIG9yZGVyLFxuICAgICAgbGV2ZWwsXG4gICAgfTtcbiAgfVxuXG4gIC8vIFJldHVybnMgYSBwcm9taXNlIGZvciBhIHtyZXNwb25zZX0gb2JqZWN0LlxuICAvLyBxdWVyeSBwYXJhbXM6XG4gIC8vIGxldmVsIChvcHRpb25hbCkgTGV2ZWwgb2YgbG9nZ2luZyB5b3Ugd2FudCB0byBxdWVyeSBmb3IgKGluZm8gfHwgZXJyb3IpXG4gIC8vIGZyb20gKG9wdGlvbmFsKSBTdGFydCB0aW1lIGZvciB0aGUgc2VhcmNoLiBEZWZhdWx0cyB0byAxIHdlZWsgYWdvLlxuICAvLyB1bnRpbCAob3B0aW9uYWwpIEVuZCB0aW1lIGZvciB0aGUgc2VhcmNoLiBEZWZhdWx0cyB0byBjdXJyZW50IHRpbWUuXG4gIC8vIG9yZGVyIChvcHRpb25hbCkgRGlyZWN0aW9uIG9mIHJlc3VsdHMgcmV0dXJuZWQsIGVpdGhlciDigJxhc2PigJ0gb3Ig4oCcZGVzY+KAnS4gRGVmYXVsdHMgdG8g4oCcZGVzY+KAnS5cbiAgLy8gc2l6ZSAob3B0aW9uYWwpIE51bWJlciBvZiByb3dzIHJldHVybmVkIGJ5IHNlYXJjaC4gRGVmYXVsdHMgdG8gMTBcbiAgZ2V0TG9ncyhvcHRpb25zID0ge30pIHtcbiAgICBpZiAoIXRoaXMuYWRhcHRlcikge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLlBVU0hfTUlTQ09ORklHVVJFRCwgJ0xvZ2dlciBhZGFwdGVyIGlzIG5vdCBhdmFpbGFibGUnKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0aGlzLmFkYXB0ZXIucXVlcnkgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELFxuICAgICAgICAnUXVlcnlpbmcgbG9ncyBpcyBub3Qgc3VwcG9ydGVkIHdpdGggdGhpcyBhZGFwdGVyJ1xuICAgICAgKTtcbiAgICB9XG4gICAgb3B0aW9ucyA9IExvZ2dlckNvbnRyb2xsZXIucGFyc2VPcHRpb25zKG9wdGlvbnMpO1xuICAgIHJldHVybiB0aGlzLmFkYXB0ZXIucXVlcnkob3B0aW9ucyk7XG4gIH1cblxuICBleHBlY3RlZEFkYXB0ZXJUeXBlKCkge1xuICAgIHJldHVybiBMb2dnZXJBZGFwdGVyO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IExvZ2dlckNvbnRyb2xsZXI7XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQUFBLEtBQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLG9CQUFBLEdBQUFDLHNCQUFBLENBQUFGLE9BQUE7QUFDQSxJQUFBRyxjQUFBLEdBQUFILE9BQUE7QUFBaUUsU0FBQUUsdUJBQUFFLEdBQUEsV0FBQUEsR0FBQSxJQUFBQSxHQUFBLENBQUFDLFVBQUEsR0FBQUQsR0FBQSxLQUFBRSxPQUFBLEVBQUFGLEdBQUE7QUFFakUsTUFBTUcscUJBQXFCLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSTtBQUNqRCxNQUFNQywwQkFBMEIsR0FBRyxJQUFJO0FBQ3ZDLE1BQU1DLGdCQUFnQixHQUFHLGlCQUFpQjtBQUVuQyxNQUFNQyxRQUFRLEdBQUc7RUFDdEJDLElBQUksRUFBRSxNQUFNO0VBQ1pDLEtBQUssRUFBRTtBQUNULENBQUM7QUFBQ0MsT0FBQSxDQUFBSCxRQUFBLEdBQUFBLFFBQUE7QUFFSyxNQUFNSSxRQUFRLEdBQUc7RUFDdEJDLFVBQVUsRUFBRSxNQUFNO0VBQ2xCQyxTQUFTLEVBQUU7QUFDYixDQUFDO0FBQUNILE9BQUEsQ0FBQUMsUUFBQSxHQUFBQSxRQUFBO0FB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