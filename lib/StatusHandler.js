"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.flatten = flatten;
exports.jobStatusHandler = jobStatusHandler;
exports.pushStatusHandler = pushStatusHandler;

var _cryptoUtils = require("./cryptoUtils");

var _KeyPromiseQueue = require("./KeyPromiseQueue");

var _logger = require("./logger");

var _rest = _interopRequireDefault(require("./rest"));

var _Auth = _interopRequireDefault(require("./Auth"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const PUSH_STATUS_COLLECTION = '_PushStatus';
const JOB_STATUS_COLLECTION = '_JobStatus';
const pushPromiseQueue = new _KeyPromiseQueue.KeyPromiseQueue();
const jobPromiseQueue = new _KeyPromiseQueue.KeyPromiseQueue();

const incrementOp = function (object = {}, key, amount = 1) {
  if (!object[key]) {
    object[key] = {
      __op: 'Increment',
      amount: amount
    };
  } else {
    object[key].amount += amount;
  }

  return object[key];
};

function flatten(array) {
  var flattened = [];

  for (var i = 0; i < array.length; i++) {
    if (Array.isArray(array[i])) {
      flattened = flattened.concat(flatten(array[i]));
    } else {
      flattened.push(array[i]);
    }
  }

  return flattened;
}

function statusHandler(className, database) {
  function create(object) {
    return database.create(className, object).then(() => {
      return Promise.resolve(object);
    });
  }

  function update(where, object) {
    return jobPromiseQueue.enqueue(where.objectId, () => database.update(className, where, object));
  }

  return Object.freeze({
    create,
    update
  });
}

function restStatusHandler(className, config) {
  const auth = _Auth.default.master(config);

  function create(object) {
    return _rest.default.create(config, auth, className, object).then(({
      response
    }) => {
      return _objectSpread(_objectSpread({}, object), response);
    });
  }

  function update(where, object) {
    return pushPromiseQueue.enqueue(where.objectId, () => _rest.default.update(config, auth, className, {
      objectId: where.objectId
    }, object).then(({
      response
    }) => {
      return _objectSpread(_objectSpread({}, object), response);
    }));
  }

  return Object.freeze({
    create,
    update
  });
}

function jobStatusHandler(config) {
  let jobStatus;
  const objectId = (0, _cryptoUtils.newObjectId)(config.objectIdSize);
  const database = config.database;
  const handler = statusHandler(JOB_STATUS_COLLECTION, database);

  const setRunning = function (jobName, params) {
    const now = new Date();
    jobStatus = {
      objectId,
      jobName,
      params,
      status: 'running',
      source: 'api',
      createdAt: now,
      // lockdown!
      ACL: {}
    };
    return handler.create(jobStatus);
  };

  const setMessage = function (message) {
    if (!message || typeof message !== 'string') {
      return Promise.resolve();
    }

    return handler.update({
      objectId
    }, {
      message
    });
  };

  const setSucceeded = function (message) {
    return setFinalStatus('succeeded', message);
  };

  const setFailed = function (message) {
    return setFinalStatus('failed', message);
  };

  const setFinalStatus = function (status, message = undefined) {
    const finishedAt = new Date();
    const update = {
      status,
      finishedAt
    };

    if (message && typeof message === 'string') {
      update.message = message;
    }

    if (message instanceof Error && typeof message.message === 'string') {
      update.message = message.message;
    }

    return handler.update({
      objectId
    }, update);
  };

  return Object.freeze({
    setRunning,
    setSucceeded,
    setMessage,
    setFailed
  });
}

function pushStatusHandler(config, existingObjectId) {
  let pushStatus;
  const database = config.database;
  const handler = restStatusHandler(PUSH_STATUS_COLLECTION, config);
  let objectId = existingObjectId;

  const setInitial = function (body = {}, where, options = {
    source: 'rest'
  }) {
    const now = new Date();
    let pushTime = now.toISOString();
    let status = 'pending';

    if (Object.prototype.hasOwnProperty.call(body, 'push_time')) {
      if (config.hasPushScheduledSupport) {
        pushTime = body.push_time;
        status = 'scheduled';
      } else {
        _logger.logger.warn('Trying to schedule a push while server is not configured.');

        _logger.logger.warn('Push will be sent immediately');
      }
    }

    const data = body.data || {};
    const payloadString = JSON.stringify(data);
    let pushHash;

    if (typeof data.alert === 'string') {
      pushHash = (0, _cryptoUtils.md5Hash)(data.alert);
    } else if (typeof data.alert === 'object') {
      pushHash = (0, _cryptoUtils.md5Hash)(JSON.stringify(data.alert));
    } else {
      pushHash = 'd41d8cd98f00b204e9800998ecf8427e';
    }

    const object = {
      pushTime,
      query: JSON.stringify(where),
      payload: payloadString,
      source: options.source,
      title: options.title,
      expiry: body.expiration_time,
      expiration_interval: body.expiration_interval,
      status: status,
      numSent: 0,
      pushHash,
      // lockdown!
      ACL: {}
    };
    return handler.create(object).then(result => {
      objectId = result.objectId;
      pushStatus = {
        objectId
      };
      return Promise.resolve(pushStatus);
    });
  };

  const setRunning = function (batches) {
    _logger.logger.verbose(`_PushStatus ${objectId}: sending push to installations with %d batches`, batches);

    return handler.update({
      status: 'pending',
      objectId: objectId
    }, {
      status: 'running',
      count: batches
    });
  };

  const update = function (update) {
    _logger.logger.verbose(`_PushStatus ${objectId}: updating values %j`, update);

    return handler.update({
      objectId
    }, update);
  };

  const trackSent = function (results, UTCOffset, cleanupInstallations = process.env.PARSE_SERVER_CLEANUP_INVALID_INSTALLATIONS) {
    const update = {
      numSent: 0,
      numFailed: 0
    };
    const devicesToRemove = [];

    if (Array.isArray(results)) {
      results = flatten(results);
      results.reduce((memo, result) => {
        // Cannot handle that
        if (!result || !result.device || !result.device.deviceType) {
          return memo;
        }

        const deviceType = result.device.deviceType;
        const key = result.transmitted ? `sentPerType.${deviceType}` : `failedPerType.${deviceType}`;
        memo[key] = incrementOp(memo, key);

        if (typeof UTCOffset !== 'undefined') {
          const offsetKey = result.transmitted ? `sentPerUTCOffset.${UTCOffset}` : `failedPerUTCOffset.${UTCOffset}`;
          memo[offsetKey] = incrementOp(memo, offsetKey);
        }

        if (result.transmitted) {
          memo.numSent++;
        } else {
          if (result && result.response && result.response.error && result.device && result.device.deviceToken) {
            const token = result.device.deviceToken;
            const error = result.response.error; // GCM errors

            if (error === 'NotRegistered' || error === 'InvalidRegistration') {
              devicesToRemove.push(token);
            } // APNS errors


            if (error === 'Unregistered' || error === 'BadDeviceToken') {
              devicesToRemove.push(token);
            }
          }

          memo.numFailed++;
        }

        return memo;
      }, update);
    }

    _logger.logger.verbose(`_PushStatus ${objectId}: sent push! %d success, %d failures`, update.numSent, update.numFailed);

    _logger.logger.verbose(`_PushStatus ${objectId}: needs cleanup`, {
      devicesToRemove
    });

    ['numSent', 'numFailed'].forEach(key => {
      if (update[key] > 0) {
        update[key] = {
          __op: 'Increment',
          amount: update[key]
        };
      } else {
        delete update[key];
      }
    });

    if (devicesToRemove.length > 0 && cleanupInstallations) {
      _logger.logger.info(`Removing device tokens on ${devicesToRemove.length} _Installations`);

      database.update('_Installation', {
        deviceToken: {
          $in: devicesToRemove
        }
      }, {
        deviceToken: {
          __op: 'Delete'
        }
      }, {
        acl: undefined,
        many: true
      });
    }

    incrementOp(update, 'count', -1);
    update.status = 'running';
    return handler.update({
      objectId
    }, update).then(res => {
      if (res && res.count === 0) {
        return this.complete();
      }
    });
  };

  const complete = function () {
    return handler.update({
      objectId
    }, {
      status: 'succeeded',
      count: {
        __op: 'Delete'
      }
    });
  };

  const fail = function (err) {
    if (typeof err === 'string') {
      err = {
        message: err
      };
    }

    const update = {
      errorMessage: err,
      status: 'failed'
    };
    return handler.update({
      objectId
    }, update);
  };

  const rval = {
    setInitial,
    setRunning,
    trackSent,
    complete,
    update,
    fail
  }; // define objectId to be dynamic

  Object.defineProperty(rval, 'objectId', {
    get: () => objectId
  });
  return Object.freeze(rval);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQVVNIX1NUQVRVU19DT0xMRUNUSU9OIiwiSk9CX1NUQVRVU19DT0xMRUNUSU9OIiwicHVzaFByb21pc2VRdWV1ZSIsIktleVByb21pc2VRdWV1ZSIsImpvYlByb21pc2VRdWV1ZSIsImluY3JlbWVudE9wIiwib2JqZWN0Iiwia2V5IiwiYW1vdW50IiwiX19vcCIsImZsYXR0ZW4iLCJhcnJheSIsImZsYXR0ZW5lZCIsImkiLCJsZW5ndGgiLCJBcnJheSIsImlzQXJyYXkiLCJjb25jYXQiLCJwdXNoIiwic3RhdHVzSGFuZGxlciIsImNsYXNzTmFtZSIsImRhdGFiYXNlIiwiY3JlYXRlIiwidGhlbiIsIlByb21pc2UiLCJyZXNvbHZlIiwidXBkYXRlIiwid2hlcmUiLCJlbnF1ZXVlIiwib2JqZWN0SWQiLCJPYmplY3QiLCJmcmVlemUiLCJyZXN0U3RhdHVzSGFuZGxlciIsImNvbmZpZyIsImF1dGgiLCJBdXRoIiwibWFzdGVyIiwicmVzdCIsInJlc3BvbnNlIiwiam9iU3RhdHVzSGFuZGxlciIsImpvYlN0YXR1cyIsIm5ld09iamVjdElkIiwib2JqZWN0SWRTaXplIiwiaGFuZGxlciIsInNldFJ1bm5pbmciLCJqb2JOYW1lIiwicGFyYW1zIiwibm93IiwiRGF0ZSIsInN0YXR1cyIsInNvdXJjZSIsImNyZWF0ZWRBdCIsIkFDTCIsInNldE1lc3NhZ2UiLCJtZXNzYWdlIiwic2V0U3VjY2VlZGVkIiwic2V0RmluYWxTdGF0dXMiLCJzZXRGYWlsZWQiLCJ1bmRlZmluZWQiLCJmaW5pc2hlZEF0IiwiRXJyb3IiLCJwdXNoU3RhdHVzSGFuZGxlciIsImV4aXN0aW5nT2JqZWN0SWQiLCJwdXNoU3RhdHVzIiwic2V0SW5pdGlhbCIsImJvZHkiLCJvcHRpb25zIiwicHVzaFRpbWUiLCJ0b0lTT1N0cmluZyIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImhhc1B1c2hTY2hlZHVsZWRTdXBwb3J0IiwicHVzaF90aW1lIiwibG9nZ2VyIiwid2FybiIsImRhdGEiLCJwYXlsb2FkU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsInB1c2hIYXNoIiwiYWxlcnQiLCJtZDVIYXNoIiwicXVlcnkiLCJwYXlsb2FkIiwidGl0bGUiLCJleHBpcnkiLCJleHBpcmF0aW9uX3RpbWUiLCJleHBpcmF0aW9uX2ludGVydmFsIiwibnVtU2VudCIsInJlc3VsdCIsImJhdGNoZXMiLCJ2ZXJib3NlIiwiY291bnQiLCJ0cmFja1NlbnQiLCJyZXN1bHRzIiwiVVRDT2Zmc2V0IiwiY2xlYW51cEluc3RhbGxhdGlvbnMiLCJwcm9jZXNzIiwiZW52IiwiUEFSU0VfU0VSVkVSX0NMRUFOVVBfSU5WQUxJRF9JTlNUQUxMQVRJT05TIiwibnVtRmFpbGVkIiwiZGV2aWNlc1RvUmVtb3ZlIiwicmVkdWNlIiwibWVtbyIsImRldmljZSIsImRldmljZVR5cGUiLCJ0cmFuc21pdHRlZCIsIm9mZnNldEtleSIsImVycm9yIiwiZGV2aWNlVG9rZW4iLCJ0b2tlbiIsImZvckVhY2giLCJpbmZvIiwiJGluIiwiYWNsIiwibWFueSIsInJlcyIsImNvbXBsZXRlIiwiZmFpbCIsImVyciIsImVycm9yTWVzc2FnZSIsInJ2YWwiLCJkZWZpbmVQcm9wZXJ0eSIsImdldCJdLCJzb3VyY2VzIjpbIi4uL3NyYy9TdGF0dXNIYW5kbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1kNUhhc2gsIG5ld09iamVjdElkIH0gZnJvbSAnLi9jcnlwdG9VdGlscyc7XG5pbXBvcnQgeyBLZXlQcm9taXNlUXVldWUgfSBmcm9tICcuL0tleVByb21pc2VRdWV1ZSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgcmVzdCBmcm9tICcuL3Jlc3QnO1xuaW1wb3J0IEF1dGggZnJvbSAnLi9BdXRoJztcblxuY29uc3QgUFVTSF9TVEFUVVNfQ09MTEVDVElPTiA9ICdfUHVzaFN0YXR1cyc7XG5jb25zdCBKT0JfU1RBVFVTX0NPTExFQ1RJT04gPSAnX0pvYlN0YXR1cyc7XG5cbmNvbnN0IHB1c2hQcm9taXNlUXVldWUgPSBuZXcgS2V5UHJvbWlzZVF1ZXVlKCk7XG5jb25zdCBqb2JQcm9taXNlUXVldWUgPSBuZXcgS2V5UHJvbWlzZVF1ZXVlKCk7XG5cbmNvbnN0IGluY3JlbWVudE9wID0gZnVuY3Rpb24gKG9iamVjdCA9IHt9LCBrZXksIGFtb3VudCA9IDEpIHtcbiAgaWYgKCFvYmplY3Rba2V5XSkge1xuICAgIG9iamVjdFtrZXldID0geyBfX29wOiAnSW5jcmVtZW50JywgYW1vdW50OiBhbW91bnQgfTtcbiAgfSBlbHNlIHtcbiAgICBvYmplY3Rba2V5XS5hbW91bnQgKz0gYW1vdW50O1xuICB9XG4gIHJldHVybiBvYmplY3Rba2V5XTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBmbGF0dGVuKGFycmF5KSB7XG4gIHZhciBmbGF0dGVuZWQgPSBbXTtcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgIGlmIChBcnJheS5pc0FycmF5KGFycmF5W2ldKSkge1xuICAgICAgZmxhdHRlbmVkID0gZmxhdHRlbmVkLmNvbmNhdChmbGF0dGVuKGFycmF5W2ldKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZsYXR0ZW5lZC5wdXNoKGFycmF5W2ldKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZsYXR0ZW5lZDtcbn1cblxuZnVuY3Rpb24gc3RhdHVzSGFuZGxlcihjbGFzc05hbWUsIGRhdGFiYXNlKSB7XG4gIGZ1bmN0aW9uIGNyZWF0ZShvYmplY3QpIHtcbiAgICByZXR1cm4gZGF0YWJhc2UuY3JlYXRlKGNsYXNzTmFtZSwgb2JqZWN0KS50aGVuKCgpID0+IHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUob2JqZWN0KTtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHVwZGF0ZSh3aGVyZSwgb2JqZWN0KSB7XG4gICAgcmV0dXJuIGpvYlByb21pc2VRdWV1ZS5lbnF1ZXVlKHdoZXJlLm9iamVjdElkLCAoKSA9PiBkYXRhYmFzZS51cGRhdGUoY2xhc3NOYW1lLCB3aGVyZSwgb2JqZWN0KSk7XG4gIH1cblxuICByZXR1cm4gT2JqZWN0LmZyZWV6ZSh7XG4gICAgY3JlYXRlLFxuICAgIHVwZGF0ZSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlc3RTdGF0dXNIYW5kbGVyKGNsYXNzTmFtZSwgY29uZmlnKSB7XG4gIGNvbnN0IGF1dGggPSBBdXRoLm1hc3Rlcihjb25maWcpO1xuICBmdW5jdGlvbiBjcmVhdGUob2JqZWN0KSB7XG4gICAgcmV0dXJuIHJlc3QuY3JlYXRlKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCBvYmplY3QpLnRoZW4oKHsgcmVzcG9uc2UgfSkgPT4ge1xuICAgICAgcmV0dXJuIHsgLi4ub2JqZWN0LCAuLi5yZXNwb25zZSB9O1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gdXBkYXRlKHdoZXJlLCBvYmplY3QpIHtcbiAgICByZXR1cm4gcHVzaFByb21pc2VRdWV1ZS5lbnF1ZXVlKHdoZXJlLm9iamVjdElkLCAoKSA9PlxuICAgICAgcmVzdFxuICAgICAgICAudXBkYXRlKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCB7IG9iamVjdElkOiB3aGVyZS5vYmplY3RJZCB9LCBvYmplY3QpXG4gICAgICAgIC50aGVuKCh7IHJlc3BvbnNlIH0pID0+IHtcbiAgICAgICAgICByZXR1cm4geyAuLi5vYmplY3QsIC4uLnJlc3BvbnNlIH07XG4gICAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiBPYmplY3QuZnJlZXplKHtcbiAgICBjcmVhdGUsXG4gICAgdXBkYXRlLFxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGpvYlN0YXR1c0hhbmRsZXIoY29uZmlnKSB7XG4gIGxldCBqb2JTdGF0dXM7XG4gIGNvbnN0IG9iamVjdElkID0gbmV3T2JqZWN0SWQoY29uZmlnLm9iamVjdElkU2l6ZSk7XG4gIGNvbnN0IGRhdGFiYXNlID0gY29uZmlnLmRhdGFiYXNlO1xuICBjb25zdCBoYW5kbGVyID0gc3RhdHVzSGFuZGxlcihKT0JfU1RBVFVTX0NPTExFQ1RJT04sIGRhdGFiYXNlKTtcbiAgY29uc3Qgc2V0UnVubmluZyA9IGZ1bmN0aW9uIChqb2JOYW1lLCBwYXJhbXMpIHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGpvYlN0YXR1cyA9IHtcbiAgICAgIG9iamVjdElkLFxuICAgICAgam9iTmFtZSxcbiAgICAgIHBhcmFtcyxcbiAgICAgIHN0YXR1czogJ3J1bm5pbmcnLFxuICAgICAgc291cmNlOiAnYXBpJyxcbiAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgLy8gbG9ja2Rvd24hXG4gICAgICBBQ0w6IHt9LFxuICAgIH07XG5cbiAgICByZXR1cm4gaGFuZGxlci5jcmVhdGUoam9iU3RhdHVzKTtcbiAgfTtcblxuICBjb25zdCBzZXRNZXNzYWdlID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICBpZiAoIW1lc3NhZ2UgfHwgdHlwZW9mIG1lc3NhZ2UgIT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuICAgIHJldHVybiBoYW5kbGVyLnVwZGF0ZSh7IG9iamVjdElkIH0sIHsgbWVzc2FnZSB9KTtcbiAgfTtcblxuICBjb25zdCBzZXRTdWNjZWVkZWQgPSBmdW5jdGlvbiAobWVzc2FnZSkge1xuICAgIHJldHVybiBzZXRGaW5hbFN0YXR1cygnc3VjY2VlZGVkJywgbWVzc2FnZSk7XG4gIH07XG5cbiAgY29uc3Qgc2V0RmFpbGVkID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICByZXR1cm4gc2V0RmluYWxTdGF0dXMoJ2ZhaWxlZCcsIG1lc3NhZ2UpO1xuICB9O1xuXG4gIGNvbnN0IHNldEZpbmFsU3RhdHVzID0gZnVuY3Rpb24gKHN0YXR1cywgbWVzc2FnZSA9IHVuZGVmaW5lZCkge1xuICAgIGNvbnN0IGZpbmlzaGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IHVwZGF0ZSA9IHsgc3RhdHVzLCBmaW5pc2hlZEF0IH07XG4gICAgaWYgKG1lc3NhZ2UgJiYgdHlwZW9mIG1lc3NhZ2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICB1cGRhdGUubWVzc2FnZSA9IG1lc3NhZ2U7XG4gICAgfVxuICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgRXJyb3IgJiYgdHlwZW9mIG1lc3NhZ2UubWVzc2FnZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHVwZGF0ZS5tZXNzYWdlID0gbWVzc2FnZS5tZXNzYWdlO1xuICAgIH1cbiAgICByZXR1cm4gaGFuZGxlci51cGRhdGUoeyBvYmplY3RJZCB9LCB1cGRhdGUpO1xuICB9O1xuXG4gIHJldHVybiBPYmplY3QuZnJlZXplKHtcbiAgICBzZXRSdW5uaW5nLFxuICAgIHNldFN1Y2NlZWRlZCxcbiAgICBzZXRNZXNzYWdlLFxuICAgIHNldEZhaWxlZCxcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwdXNoU3RhdHVzSGFuZGxlcihjb25maWcsIGV4aXN0aW5nT2JqZWN0SWQpIHtcbiAgbGV0IHB1c2hTdGF0dXM7XG4gIGNvbnN0IGRhdGFiYXNlID0gY29uZmlnLmRhdGFiYXNlO1xuICBjb25zdCBoYW5kbGVyID0gcmVzdFN0YXR1c0hhbmRsZXIoUFVTSF9TVEFUVVNfQ09MTEVDVElPTiwgY29uZmlnKTtcbiAgbGV0IG9iamVjdElkID0gZXhpc3RpbmdPYmplY3RJZDtcbiAgY29uc3Qgc2V0SW5pdGlhbCA9IGZ1bmN0aW9uIChib2R5ID0ge30sIHdoZXJlLCBvcHRpb25zID0geyBzb3VyY2U6ICdyZXN0JyB9KSB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICBsZXQgcHVzaFRpbWUgPSBub3cudG9JU09TdHJpbmcoKTtcbiAgICBsZXQgc3RhdHVzID0gJ3BlbmRpbmcnO1xuICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYm9keSwgJ3B1c2hfdGltZScpKSB7XG4gICAgICBpZiAoY29uZmlnLmhhc1B1c2hTY2hlZHVsZWRTdXBwb3J0KSB7XG4gICAgICAgIHB1c2hUaW1lID0gYm9keS5wdXNoX3RpbWU7XG4gICAgICAgIHN0YXR1cyA9ICdzY2hlZHVsZWQnO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oJ1RyeWluZyB0byBzY2hlZHVsZSBhIHB1c2ggd2hpbGUgc2VydmVyIGlzIG5vdCBjb25maWd1cmVkLicpO1xuICAgICAgICBsb2dnZXIud2FybignUHVzaCB3aWxsIGJlIHNlbnQgaW1tZWRpYXRlbHknKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBkYXRhID0gYm9keS5kYXRhIHx8IHt9O1xuICAgIGNvbnN0IHBheWxvYWRTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShkYXRhKTtcbiAgICBsZXQgcHVzaEhhc2g7XG4gICAgaWYgKHR5cGVvZiBkYXRhLmFsZXJ0ID09PSAnc3RyaW5nJykge1xuICAgICAgcHVzaEhhc2ggPSBtZDVIYXNoKGRhdGEuYWxlcnQpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEuYWxlcnQgPT09ICdvYmplY3QnKSB7XG4gICAgICBwdXNoSGFzaCA9IG1kNUhhc2goSlNPTi5zdHJpbmdpZnkoZGF0YS5hbGVydCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwdXNoSGFzaCA9ICdkNDFkOGNkOThmMDBiMjA0ZTk4MDA5OThlY2Y4NDI3ZSc7XG4gICAgfVxuICAgIGNvbnN0IG9iamVjdCA9IHtcbiAgICAgIHB1c2hUaW1lLFxuICAgICAgcXVlcnk6IEpTT04uc3RyaW5naWZ5KHdoZXJlKSxcbiAgICAgIHBheWxvYWQ6IHBheWxvYWRTdHJpbmcsXG4gICAgICBzb3VyY2U6IG9wdGlvbnMuc291cmNlLFxuICAgICAgdGl0bGU6IG9wdGlvbnMudGl0bGUsXG4gICAgICBleHBpcnk6IGJvZHkuZXhwaXJhdGlvbl90aW1lLFxuICAgICAgZXhwaXJhdGlvbl9pbnRlcnZhbDogYm9keS5leHBpcmF0aW9uX2ludGVydmFsLFxuICAgICAgc3RhdHVzOiBzdGF0dXMsXG4gICAgICBudW1TZW50OiAwLFxuICAgICAgcHVzaEhhc2gsXG4gICAgICAvLyBsb2NrZG93biFcbiAgICAgIEFDTDoge30sXG4gICAgfTtcbiAgICByZXR1cm4gaGFuZGxlci5jcmVhdGUob2JqZWN0KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBvYmplY3RJZCA9IHJlc3VsdC5vYmplY3RJZDtcbiAgICAgIHB1c2hTdGF0dXMgPSB7XG4gICAgICAgIG9iamVjdElkLFxuICAgICAgfTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocHVzaFN0YXR1cyk7XG4gICAgfSk7XG4gIH07XG5cbiAgY29uc3Qgc2V0UnVubmluZyA9IGZ1bmN0aW9uIChiYXRjaGVzKSB7XG4gICAgbG9nZ2VyLnZlcmJvc2UoXG4gICAgICBgX1B1c2hTdGF0dXMgJHtvYmplY3RJZH06IHNlbmRpbmcgcHVzaCB0byBpbnN0YWxsYXRpb25zIHdpdGggJWQgYmF0Y2hlc2AsXG4gICAgICBiYXRjaGVzXG4gICAgKTtcbiAgICByZXR1cm4gaGFuZGxlci51cGRhdGUoXG4gICAgICB7XG4gICAgICAgIHN0YXR1czogJ3BlbmRpbmcnLFxuICAgICAgICBvYmplY3RJZDogb2JqZWN0SWQsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBzdGF0dXM6ICdydW5uaW5nJyxcbiAgICAgICAgY291bnQ6IGJhdGNoZXMsXG4gICAgICB9XG4gICAgKTtcbiAgfTtcblxuICBjb25zdCB1cGRhdGUgPSBmdW5jdGlvbiAodXBkYXRlKSB7XG4gICAgbG9nZ2VyLnZlcmJvc2UoYF9QdXNoU3RhdHVzICR7b2JqZWN0SWR9OiB1cGRhdGluZyB2YWx1ZXMgJWpgLCB1cGRhdGUpO1xuICAgIHJldHVybiBoYW5kbGVyLnVwZGF0ZSh7IG9iamVjdElkIH0sIHVwZGF0ZSk7XG4gIH07XG5cbiAgY29uc3QgdHJhY2tTZW50ID0gZnVuY3Rpb24gKFxuICAgIHJlc3VsdHMsXG4gICAgVVRDT2Zmc2V0LFxuICAgIGNsZWFudXBJbnN0YWxsYXRpb25zID0gcHJvY2Vzcy5lbnYuUEFSU0VfU0VSVkVSX0NMRUFOVVBfSU5WQUxJRF9JTlNUQUxMQVRJT05TXG4gICkge1xuICAgIGNvbnN0IHVwZGF0ZSA9IHtcbiAgICAgIG51bVNlbnQ6IDAsXG4gICAgICBudW1GYWlsZWQ6IDAsXG4gICAgfTtcbiAgICBjb25zdCBkZXZpY2VzVG9SZW1vdmUgPSBbXTtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHRzKSkge1xuICAgICAgcmVzdWx0cyA9IGZsYXR0ZW4ocmVzdWx0cyk7XG4gICAgICByZXN1bHRzLnJlZHVjZSgobWVtbywgcmVzdWx0KSA9PiB7XG4gICAgICAgIC8vIENhbm5vdCBoYW5kbGUgdGhhdFxuICAgICAgICBpZiAoIXJlc3VsdCB8fCAhcmVzdWx0LmRldmljZSB8fCAhcmVzdWx0LmRldmljZS5kZXZpY2VUeXBlKSB7XG4gICAgICAgICAgcmV0dXJuIG1lbW87XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGV2aWNlVHlwZSA9IHJlc3VsdC5kZXZpY2UuZGV2aWNlVHlwZTtcbiAgICAgICAgY29uc3Qga2V5ID0gcmVzdWx0LnRyYW5zbWl0dGVkXG4gICAgICAgICAgPyBgc2VudFBlclR5cGUuJHtkZXZpY2VUeXBlfWBcbiAgICAgICAgICA6IGBmYWlsZWRQZXJUeXBlLiR7ZGV2aWNlVHlwZX1gO1xuICAgICAgICBtZW1vW2tleV0gPSBpbmNyZW1lbnRPcChtZW1vLCBrZXkpO1xuICAgICAgICBpZiAodHlwZW9mIFVUQ09mZnNldCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICBjb25zdCBvZmZzZXRLZXkgPSByZXN1bHQudHJhbnNtaXR0ZWRcbiAgICAgICAgICAgID8gYHNlbnRQZXJVVENPZmZzZXQuJHtVVENPZmZzZXR9YFxuICAgICAgICAgICAgOiBgZmFpbGVkUGVyVVRDT2Zmc2V0LiR7VVRDT2Zmc2V0fWA7XG4gICAgICAgICAgbWVtb1tvZmZzZXRLZXldID0gaW5jcmVtZW50T3AobWVtbywgb2Zmc2V0S2V5KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0LnRyYW5zbWl0dGVkKSB7XG4gICAgICAgICAgbWVtby5udW1TZW50Kys7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgcmVzdWx0ICYmXG4gICAgICAgICAgICByZXN1bHQucmVzcG9uc2UgJiZcbiAgICAgICAgICAgIHJlc3VsdC5yZXNwb25zZS5lcnJvciAmJlxuICAgICAgICAgICAgcmVzdWx0LmRldmljZSAmJlxuICAgICAgICAgICAgcmVzdWx0LmRldmljZS5kZXZpY2VUb2tlblxuICAgICAgICAgICkge1xuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSByZXN1bHQuZGV2aWNlLmRldmljZVRva2VuO1xuICAgICAgICAgICAgY29uc3QgZXJyb3IgPSByZXN1bHQucmVzcG9uc2UuZXJyb3I7XG4gICAgICAgICAgICAvLyBHQ00gZXJyb3JzXG4gICAgICAgICAgICBpZiAoZXJyb3IgPT09ICdOb3RSZWdpc3RlcmVkJyB8fCBlcnJvciA9PT0gJ0ludmFsaWRSZWdpc3RyYXRpb24nKSB7XG4gICAgICAgICAgICAgIGRldmljZXNUb1JlbW92ZS5wdXNoKHRva2VuKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIEFQTlMgZXJyb3JzXG4gICAgICAgICAgICBpZiAoZXJyb3IgPT09ICdVbnJlZ2lzdGVyZWQnIHx8IGVycm9yID09PSAnQmFkRGV2aWNlVG9rZW4nKSB7XG4gICAgICAgICAgICAgIGRldmljZXNUb1JlbW92ZS5wdXNoKHRva2VuKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgbWVtby5udW1GYWlsZWQrKztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbWVtbztcbiAgICAgIH0sIHVwZGF0ZSk7XG4gICAgfVxuXG4gICAgbG9nZ2VyLnZlcmJvc2UoXG4gICAgICBgX1B1c2hTdGF0dXMgJHtvYmplY3RJZH06IHNlbnQgcHVzaCEgJWQgc3VjY2VzcywgJWQgZmFpbHVyZXNgLFxuICAgICAgdXBkYXRlLm51bVNlbnQsXG4gICAgICB1cGRhdGUubnVtRmFpbGVkXG4gICAgKTtcbiAgICBsb2dnZXIudmVyYm9zZShgX1B1c2hTdGF0dXMgJHtvYmplY3RJZH06IG5lZWRzIGNsZWFudXBgLCB7XG4gICAgICBkZXZpY2VzVG9SZW1vdmUsXG4gICAgfSk7XG4gICAgWydudW1TZW50JywgJ251bUZhaWxlZCddLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGlmICh1cGRhdGVba2V5XSA+IDApIHtcbiAgICAgICAgdXBkYXRlW2tleV0gPSB7XG4gICAgICAgICAgX19vcDogJ0luY3JlbWVudCcsXG4gICAgICAgICAgYW1vdW50OiB1cGRhdGVba2V5XSxcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlbGV0ZSB1cGRhdGVba2V5XTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChkZXZpY2VzVG9SZW1vdmUubGVuZ3RoID4gMCAmJiBjbGVhbnVwSW5zdGFsbGF0aW9ucykge1xuICAgICAgbG9nZ2VyLmluZm8oYFJlbW92aW5nIGRldmljZSB0b2tlbnMgb24gJHtkZXZpY2VzVG9SZW1vdmUubGVuZ3RofSBfSW5zdGFsbGF0aW9uc2ApO1xuICAgICAgZGF0YWJhc2UudXBkYXRlKFxuICAgICAgICAnX0luc3RhbGxhdGlvbicsXG4gICAgICAgIHsgZGV2aWNlVG9rZW46IHsgJGluOiBkZXZpY2VzVG9SZW1vdmUgfSB9LFxuICAgICAgICB7IGRldmljZVRva2VuOiB7IF9fb3A6ICdEZWxldGUnIH0gfSxcbiAgICAgICAge1xuICAgICAgICAgIGFjbDogdW5kZWZpbmVkLFxuICAgICAgICAgIG1hbnk6IHRydWUsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICAgIGluY3JlbWVudE9wKHVwZGF0ZSwgJ2NvdW50JywgLTEpO1xuICAgIHVwZGF0ZS5zdGF0dXMgPSAncnVubmluZyc7XG5cbiAgICByZXR1cm4gaGFuZGxlci51cGRhdGUoeyBvYmplY3RJZCB9LCB1cGRhdGUpLnRoZW4ocmVzID0+IHtcbiAgICAgIGlmIChyZXMgJiYgcmVzLmNvdW50ID09PSAwKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbXBsZXRlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgY29uc3QgY29tcGxldGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGhhbmRsZXIudXBkYXRlKFxuICAgICAgeyBvYmplY3RJZCB9LFxuICAgICAge1xuICAgICAgICBzdGF0dXM6ICdzdWNjZWVkZWQnLFxuICAgICAgICBjb3VudDogeyBfX29wOiAnRGVsZXRlJyB9LFxuICAgICAgfVxuICAgICk7XG4gIH07XG5cbiAgY29uc3QgZmFpbCA9IGZ1bmN0aW9uIChlcnIpIHtcbiAgICBpZiAodHlwZW9mIGVyciA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGVyciA9IHsgbWVzc2FnZTogZXJyIH07XG4gICAgfVxuICAgIGNvbnN0IHVwZGF0ZSA9IHtcbiAgICAgIGVycm9yTWVzc2FnZTogZXJyLFxuICAgICAgc3RhdHVzOiAnZmFpbGVkJyxcbiAgICB9O1xuICAgIHJldHVybiBoYW5kbGVyLnVwZGF0ZSh7IG9iamVjdElkIH0sIHVwZGF0ZSk7XG4gIH07XG5cbiAgY29uc3QgcnZhbCA9IHtcbiAgICBzZXRJbml0aWFsLFxuICAgIHNldFJ1bm5pbmcsXG4gICAgdHJhY2tTZW50LFxuICAgIGNvbXBsZXRlLFxuICAgIHVwZGF0ZSxcbiAgICBmYWlsLFxuICB9O1xuXG4gIC8vIGRlZmluZSBvYmplY3RJZCB0byBiZSBkeW5hbWljXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShydmFsLCAnb2JqZWN0SWQnLCB7XG4gICAgZ2V0OiAoKSA9PiBvYmplY3RJZCxcbiAgfSk7XG5cbiAgcmV0dXJuIE9iamVjdC5mcmVlemUocnZhbCk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0FBRUEsTUFBTUEsc0JBQXNCLEdBQUcsYUFBL0I7QUFDQSxNQUFNQyxxQkFBcUIsR0FBRyxZQUE5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